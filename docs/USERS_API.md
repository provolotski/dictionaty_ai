# API пользователей системы

## Обзор

API для управления пользователями системы предоставляет endpoints для получения информации о пользователях, зарегистрированных в системе.

## Endpoints

### 1. Получение списка пользователей

**GET** `/api/v1/users/`

Получает список всех пользователей с пагинацией и возможностью фильтрации.

#### Query параметры:

- `domain` (опционально) - фильтр по домену пользователя
- `search` (опционально) - поиск по имени пользователя (регистронезависимый)
- `page` (по умолчанию: 1) - номер страницы
- `page_size` (по умолчанию: 25, максимум: 100) - размер страницы

#### Примеры запросов:

```bash
# Получить всех пользователей (первая страница)
GET /api/v1/users/

# Получить пользователей домена belstat
GET /api/v1/users/?domain=belstat

# Поиск пользователей с "admin" в имени
GET /api/v1/users/?search=admin

# Пагинация
GET /api/v1/users/?page=2&page_size=10
```

#### Ответ:

```json
{
  "users": [
    {
      "id": 1,
      "guid": "8c527f4d-c073-453c-b8b5-082e040b4d19",
      "name": "Админ СП_БД",
      "domain": "belstat",
      "is_admin": true,
      "last_login_at": "2025-01-20T14:45:00Z"
    }
  ],
  "total": 25,
  "page": 1,
  "page_size": 25,
  "total_pages": 1
}
```

### 2. Таблица пользователей
Отображает следующие поля:
- **ID** - внутренний идентификатор пользователя
- **GUID** - глобальный уникальный идентификатор
- **Имя пользователя** - отображаемое имя
- **Домен** - домен пользователя
- **Администратор системы** - признак администратора системы (true/false)
- **Последний вход** - дата последней авторизации

### 3. Получение пользователя по ID

**GET** `/api/v1/users/{user_id}`

Получает информацию о конкретном пользователе по его ID.

#### Path параметры:

- `user_id` - ID пользователя в системе

#### Пример запроса:

```bash
GET /api/v1/users/1
```

#### Ответ:

```json
{
  "id": 1,
  "guid": "8c527f4d-c073-453c-b8b5-082e040b4d19",
  "name": "Админ СП_БД",
  "domain": "belstat",
  "is_admin": true,
  "last_login_at": "2025-01-20T14:45:00Z"
}
```

### 4. Получение пользователя по GUID

**GET** `/api/v1/users/guid/{guid}`

Получает информацию о пользователе по его GUID с опциональной фильтрацией по домену.

#### Path параметры:

- `guid` - GUID пользователя (может быть с фигурными скобками или без)

#### Query параметры:

- `domain` (опционально) - дополнительная фильтрация по домену

#### Примеры запросов:

```bash
# По GUID без домена
GET /api/v1/users/guid/8c527f4d-c073-453c-b8b5-082e040b4d19

# По GUID с доменом
GET /api/v1/users/guid/8c527f4d-c073-453c-b8b5-082e040b4d19?domain=belstat

# GUID с фигурными скобками
GET /api/v1/users/guid/{8c527f4d-c073-453c-b8b5-082e040b4d19}
```

#### Ответ:

```json
{
  "id": 1,
  "guid": "8c527f4d-c073-453c-b8b5-082e040b4d19",
  "name": "Админ СП_БД",
  "domain": "belstat",
  "is_admin": true,
  "last_login_at": "2025-01-20T14:45:00Z"
}
```

## Обработка ошибок

### 404 Not Found

Возвращается, когда пользователь не найден:

```json
{
  "detail": "Пользователь не найден"
}
```

### 500 Internal Server Error

Возвращается при внутренних ошибках сервера:

```json
{
  "detail": "Внутренняя ошибка сервера"
}
```

## Особенности реализации

1. **Автоматическая очистка GUID**: GUID автоматически очищается от фигурных скобок `{}`
2. **Регистронезависимый поиск**: Поиск по имени использует `ILIKE` для регистронезависимости
3. **Сортировка**: Пользователи сортируются по дате последнего входа (DESC), затем по имени (ASC)
4. **Пагинация**: Поддерживается пагинация с настраиваемым размером страницы
5. **Логирование**: Все операции логируются с детальной информацией

## Использование в ролевой модели

Эти endpoints предназначены для поддержки ролевой модели системы:

- **Администратор безопасности** (`EISGS_AppSecurity`) - может просматривать всех пользователей
- **Администратор системы** (`EISGS_Users` + `is_admin=true`) - может управлять пользователями
- **Хозяин справочника** - может просматривать пользователей для назначения прав
- **Пользователь системы** (`EISGS_Users`) - ограниченный доступ к информации о пользователях

## Тестирование

Для тестирования endpoints можно использовать встроенный тестовый скрипт:

```bash
cd backend
python3 test_users_endpoint.py
```

## Swagger документация

Полная документация API доступна по адресу `/docs` после запуска приложения.
