{% extends 'base.html' %}
{% load dictionary_filters %}

{% block title %}Словари | BelStat{% endblock %}

{% block extra_css %}
<style>
    /* Стили для дерева */
    .tree-container {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #fff;
    }

    .tree-node {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .tree-item {
        position: relative;
        margin: 2px 0;
    }

    .tree-item-content {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .tree-item-content:hover {
        background-color: #f8f9fa;
    }

    .tree-toggle {
        width: 20px;
        height: 20px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        border-radius: 3px;
        color: #6c757d;
    }

    .tree-toggle:hover {
        background-color: #e9ecef;
    }

    .tree-toggle.collapsed::before {
        content: '▶';
    }

    .tree-toggle.expanded::before {
        content: '▼';
    }

    .tree-toggle.leaf {
        visibility: hidden;
    }

    .tree-item-info {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tree-item-main {
        display: flex;
        flex-direction: column;
    }

    .tree-item-title {
        font-weight: 500;
        color: #212529;
        margin-bottom: 2px;
    }

    .tree-item-code {
        font-size: 0.875rem;
        color: #6c757d;
        font-family: monospace;
    }

    .tree-item-meta {
        font-size: 0.75rem;
        color: #6c757d;
        display: flex;
        gap: 10px;
    }

    .tree-item-actions {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .tree-item-content:hover .tree-item-actions {
        opacity: 1;
    }

    .tree-children {
        margin-left: 28px;
        border-left: 1px dashed #dee2e6;
        padding-left: 12px;
        display: none;
    }

    .tree-children.expanded {
        display: block;
    }

    .tree-root>.tree-children {
        margin-left: 0;
        border-left: none;
        padding-left: 0;
        display: block;
    }

    .tree-empty {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
        font-style: italic;
    }

    /* Стили для переключателя вида */
    .btn-check:checked+.btn {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-section">
        <div class="welcome-content">
            <h1 class="welcome-title">Словари и классификаторы</h1>
            <p class="welcome-subtitle">Управление иерархическими историческими словарями</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h2 class="card-title">Доступные справочники</h2>
                <p class="card-subtitle">Выберите справочник для просмотра и редактирования</p>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-3">Всего: {{ total_count }}</span>
                <button class="btn btn-outline-primary me-2" onclick="refreshDictionaries()" title="Обновить список">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
                <div class="btn-group me-2" role="group">
                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"
                        title="Экспорт списка">
                        <i class="fas fa-download"></i> Экспорт
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportDictionaries('csv')">
                                <i class="fas fa-file-csv"></i> CSV файл
                            </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportDictionaries('json')">
                                <i class="fas fa-file-code"></i> JSON файл
                            </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportDictionaries('xlsx')">
                                <i class="fas fa-file-excel"></i> Excel файл
                            </a></li>
                    </ul>
                </div>
                <button class="btn btn-success" onclick="createNewDictionary()">
                    <i class="fas fa-plus"></i> Создать словарь
                </button>
            </div>
        </div>

        <!-- Поиск и фильтры -->
        <div class="card-body border-bottom">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput"
                            placeholder="Поиск по названию или коду..." onkeyup="filterDictionaries()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearFilters()"
                            title="Очистить фильтры">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter" onchange="filterDictionaries()">
                        <option value="">Все статусы</option>
                        <option value="active">Активные</option>
                        <option value="inactive">Неактивные</option>
                        <option value="draft">Черновики</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="typeFilter" onchange="filterDictionaries()">
                        <option value="">Все типы</option>
                        <option value="classifier">Классификатор</option>
                        <option value="dictionary">Словарь</option>
                        <option value="reference">Справочник</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Используйте поиск и фильтры для быстрого нахождения нужных словарей.
                        <strong>Кликните на код или название справочника для просмотра его значений.</strong>
                        Нажмите на заголовки столбцов для сортировки.
                    </small>
                </div>
            </div>
        </div>

        <div class="card-body">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            {% if dictionaries %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th class="sortable" data-sort="code">
                                Код <i class="fas fa-sort"></i> <small class="text-muted">(кликните для
                                    просмотра)</small>
                            </th>
                            <th class="sortable" data-sort="name">
                                Название <i class="fas fa-sort"></i> <small class="text-muted">(кликните для
                                    просмотра)</small>
                            </th>
                            <th class="sortable" data-sort="description">
                                Описание <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable" data-sort="status">
                                Статус <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable" data-sort="type">
                                Тип <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable" data-sort="date">
                                Дата создания <i class="fas fa-sort"></i>
                            </th>
                            <th>Управление</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dictionary in dictionaries %}
                        <tr>
                            <td>
                                <span class="badge bg-secondary clickable-code" data-dict-id="{{ dictionary.id }}"
                                    data-dict-name="{{ dictionary.name|default:'Словарь' }}"
                                    title="Кликните для просмотра содержимого справочника" style="cursor: pointer;">
                                    {{ dictionary.code|default:"-" }}
                                </span>
                            </td>
                            <td>
                                <strong class="clickable-name" data-dict-id="{{ dictionary.id }}"
                                    data-dict-name="{{ dictionary.name|default:'Словарь' }}"
                                    title="Кликните для просмотра содержимого справочника"
                                    style="cursor: pointer; color: #007bff;">
                                    {{ dictionary.name|default:"Без названия" }}
                                </strong>
                                {% if dictionary.description %}
                                <br><small class="text-muted">{{ dictionary.description|truncatechars:100 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if dictionary.description %}
                                <span class="text-muted">{{ dictionary.description|truncatechars:80 }}</span>
                                {% else %}
                                <span class="text-muted">Описание отсутствует</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dictionary.status %}
                                {% if dictionary.status == 'active' or dictionary.status == 'активный' %}
                                <span class="badge bg-success">{{ dictionary.status }}</span>
                                {% elif dictionary.status == 'inactive' or dictionary.status == 'неактивный' %}
                                <span class="badge bg-warning">{{ dictionary.status }}</span>
                                {% elif dictionary.status == 'draft' or dictionary.status == 'черновик' %}
                                <span class="badge bg-secondary">{{ dictionary.status }}</span>
                                {% else %}
                                <span class="badge bg-info">{{ dictionary.status }}</span>
                                {% endif %}
                                {% else %}
                                <span class="badge bg-secondary">Не указан</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dictionary.type %}
                                {% if dictionary.type == 'classifier' or dictionary.type == 'классификатор' %}
                                <span class="badge bg-primary">{{ dictionary.type }}</span>
                                {% elif dictionary.type == 'dictionary' or dictionary.type == 'словарь' %}
                                <span class="badge bg-success">{{ dictionary.type }}</span>
                                {% elif dictionary.type == 'reference' or dictionary.type == 'справочник' %}
                                <span class="badge bg-info">{{ dictionary.type }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ dictionary.type }}</span>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dictionary.created_at %}
                                <small class="text-muted">{{ dictionary.created_at|date:"d.m.Y" }}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    {% if user_permissions|get_item:dictionary.id|get_item:'can_edit' %}
                                    <button class="btn btn-sm btn-outline-info edit-description-btn"
                                        data-dict-id="{{ dictionary.id }}"
                                        data-dict-name="{{ dictionary.name|default:'Словарь' }}"
                                        title="Редактировать описание">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning edit-dict-btn"
                                        data-dict-id="{{ dictionary.id }}" title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-dict-btn"
                                        data-dict-id="{{ dictionary.id }}"
                                        data-dict-name="{{ dictionary.name|default:'Словарь' }}" title="Удалить">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-info view-dict-btn"
                                        data-dict-id="{{ dictionary.id }}"
                                        data-dict-name="{{ dictionary.name|default:'Словарь' }}" title="Просмотреть">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-book fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">Словари не найдены</h4>
                <p class="text-muted">В системе пока нет созданных словарей</p>
                <button class="btn btn-primary" onclick="createNewDictionary()">
                    <i class="fas fa-plus"></i> Создать первый словарь
                </button>
            </div>
            {% endif %}

            <!-- Индикатор загрузки -->
            <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2 text-muted">Обновление списка словарей...</p>
            </div>

            <!-- Сообщения об ошибках -->
            <div id="errorMessage" class="alert alert-danger" style="display: none;" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorText"></span>
            </div>

            <!-- Информационные сообщения -->
            <div id="infoMessage" class="alert alert-info" style="display: none;" role="alert">
                <i class="fas fa-info-circle"></i>
                <span id="infoText"></span>
            </div>

            <!-- Успешные сообщения -->
            <div id="successMessage" class="alert alert-success" style="display: none;" role="alert">
                <i class="fas fa-check-circle"></i>
                <span id="successText"></span>
            </div>

            <!-- Предупреждения -->
            <div id="warningMessage" class="alert alert-warning" style="display: none;" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="warningText"></span>
            </div>

            <!-- Статистика -->
            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ total_count }}</h5>
                            <p class="card-text">Всего словарей</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="activeCount">-</h5>
                            <p class="card-text">Активных</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="draftCount">-</h5>
                            <p class="card-text">Черновиков</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title" id="classifierCount">-</h5>
                            <p class="card-text">Классификаторов</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Дополнительная информация -->
            <div class="mt-4">
                <h5>Информация о системе</h5>
                <p class="text-muted">
                    На этой странице отображаются все доступные справочники и классификаторы в системе.
                    Вы можете просматривать, редактировать и удалять справочники, а также создавать новые.
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Возможности:</h6>
                        <ul class="text-muted">
                            <li>Просмотр списка всех словарей</li>
                            <li>Поиск и фильтрация</li>
                            <li>Сортировка по любому столбцу</li>
                            <li>Экспорт данных</li>
                            <li>Создание новых словарей</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Статусы словарей:</h6>
                        <ul class="text-muted">
                            <li><span class="badge bg-success">Активный</span> - словарь доступен для использования</li>
                            <li><span class="badge bg-warning">Неактивный</span> - словарь временно недоступен</li>
                            <li><span class="badge bg-secondary">Черновик</span> - словарь в разработке</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Быстрые действия -->
            <div class="mt-4">
                <h5>Быстрые действия</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-plus-circle fa-2x text-success mb-2"></i>
                                <h6>Создать словарь</h6>
                                <p class="text-muted small">Добавить новый словарь в систему</p>
                                <button class="btn btn-outline-success btn-sm" onclick="createNewDictionary()">
                                    Создать
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-download fa-2x text-primary mb-2"></i>
                                <h6>Экспорт данных</h6>
                                <p class="text-muted small">Выгрузить список словарей</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportDictionaries('csv')">
                                    Экспорт CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-sync-alt fa-2x text-info mb-2"></i>
                                <h6>Обновить список</h6>
                                <p class="text-muted small">Получить актуальные данные</p>
                                <button class="btn btn-outline-info btn-sm" onclick="refreshDictionaries()">
                                    Обновить
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Дополнительные возможности -->
            <div class="mt-4">
                <h5>Дополнительные возможности</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Статистика</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">Просмотр статистики по словарям</p>
                                <button class="btn btn-primary btn-sm" onclick="showStatistics()">
                                    Показать статистику
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-cog"></i> Настройки</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">Настройка отображения и экспорта</p>
                                <button class="btn btn-success btn-sm" onclick="showSettings()">
                                    Настройки
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Справка -->
            <div class="mt-4">
                <h5>Справка</h5>
                <div class="accordion" id="helpAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="helpOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseOne">
                                Как работать со словарями?
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                <p>Для работы со словарями используйте следующие возможности:</p>
                                <ul>
                                    <li><strong>Просмотр:</strong> Нажмите на кнопку с иконкой глаза для просмотра
                                        содержимого словаря</li>
                                    <li><strong>Редактирование:</strong> Нажмите на кнопку с иконкой карандаша для
                                        изменения словаря</li>
                                    <li><strong>Удаление:</strong> Нажмите на кнопку с иконкой корзины для удаления
                                        словаря</li>
                                    <li><strong>Создание:</strong> Нажмите на кнопку "Создать словарь" для добавления
                                        нового</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="helpTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseTwo">
                                Как использовать поиск и фильтры?
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                <p>Поиск и фильтрация помогают быстро найти нужные словари:</p>
                                <ul>
                                    <li><strong>Поиск:</strong> Введите текст в поле поиска для фильтрации по названию
                                        или коду</li>
                                    <li><strong>Статус:</strong> Выберите статус словаря для фильтрации</li>
                                    <li><strong>Тип:</strong> Выберите тип словаря для фильтрации</li>
                                    <li><strong>Сортировка:</strong> Нажмите на заголовок столбца для сортировки</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="helpThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseThree">
                                Как экспортировать данные?
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                <p>Для экспорта данных используйте кнопку "Экспорт":</p>
                                <ul>
                                    <li><strong>CSV:</strong> Экспорт в формате CSV для Excel</li>
                                    <li><strong>JSON:</strong> Экспорт в формате JSON для программной обработки</li>
                                    <li><strong>Excel:</strong> Экспорт в формате XLSX (в разработке)</li>
                                </ul>
                                <p class="text-muted small">Примечание: экспортируются только видимые (отфильтрованные)
                                    справочники</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Контакты поддержки -->
            <div class="mt-4">
                <div class="alert alert-info">
                    <h6><i class="fas fa-question-circle"></i> Нужна помощь?</h6>
                    <p class="mb-2">Если у вас возникли вопросы по работе со словарями, обратитесь к администратору
                        системы или в службу поддержки.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Администратор:</strong> admin@belstat.by<br>
                            <strong>Телефон:</strong> +375 (17) 123-45-67
                        </div>
                        <div class="col-md-6">
                            <strong>Поддержка:</strong> support@belstat.by<br>
                            <strong>Документация:</strong> <a href="#" class="text-decoration-none">Справочник
                                пользователя</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Информация о версии -->
            <div class="mt-4 text-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Версия системы: 1.0.0 | Последнее обновление: {{ "now"|date:"d.m.Y H:i" }} |
                    <a href="#" class="text-decoration-none">История изменений</a>
                </small>
            </div>

            <!-- Футер страницы -->
            <footer class="mt-5 py-4 border-top">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Система управления словарями BelStat</h6>
                        <p class="text-muted small">
                            Современная система для управления иерархическими историческими словарями и
                            классификаторами.
                            Обеспечивает надежное хранение, поиск и управление данными.
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <h6>Полезные ссылки</h6>
                        <ul class="list-unstyled">
                            <li><a href="#" class="text-decoration-none">Документация API</a></li>
                            <li><a href="#" class="text-decoration-none">Примеры использования</a></li>
                            <li><a href="#" class="text-decoration-none">Часто задаваемые вопросы</a></li>
                        </ul>
                    </div>
                </div>
            </footer>

            <!-- Пагинация -->
            {% if total_count > 25 %}
            <nav aria-label="Навигация по словарям" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <span class="page-link">Предыдущая</span>
                    </li>
                    <li class="page-item active">
                        <span class="page-link">1</span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#">2</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#">3</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#">Следующая</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения удаления -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы действительно хотите удалить словарь <strong id="deleteDictionaryName"></strong>?</p>
                <p class="text-danger"><small>Это действие нельзя отменить!</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для информации о словаре -->
<div class="modal fade" id="dictionaryInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Информация о словаре</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dictionaryInfoContent">
                    <!-- Здесь будет загружаться информация о словаре -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="editDictionaryBtn">Редактировать</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра содержимого справочника -->
<div class="modal fade" id="dictionaryContentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dictionaryContentTitle">Содержимое справочника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="cleanupModalState()"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="badge bg-primary me-2" id="dictionaryContentCode"></span>
                        <span class="badge bg-info me-2" id="dictionaryContentStatus"></span>
                        <span class="badge bg-secondary" id="dictionaryContentType"></span>
                    </div>
                    <div class="d-flex align-items-center">
                        <!-- Переключатель вида отображения -->
                        <div class="btn-group me-3" role="group" aria-label="Вид отображения">
                            <input type="radio" class="btn-check" name="viewMode" id="tableViewMode" value="table"
                                checked>
                            <label class="btn btn-outline-primary btn-sm" for="tableViewMode"
                                onclick="switchToTableView()">
                                <i class="fas fa-table"></i> Таблица
                            </label>

                            <input type="radio" class="btn-check" name="viewMode" id="treeViewMode" value="tree">
                            <label class="btn btn-outline-primary btn-sm" for="treeViewMode"
                                onclick="switchToTreeView()">
                                <i class="fas fa-sitemap"></i> Дерево
                            </label>
                        </div>

                        <button class="btn btn-sm btn-outline-primary me-2" onclick="exportDictionaryContent()">
                            <i class="fas fa-download"></i> Экспорт
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshDictionaryContent()">
                            <i class="fas fa-sync-alt"></i> Обновить
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="testSearch()"
                            title="Тестирование поиска (отладка)">
                            <i class="fas fa-bug"></i> Тест
                        </button>
                    </div>
                </div>

                <!-- Фильтры для содержимого -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="contentSearchInput"
                            placeholder="Поиск по коду или названию...">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="contentDateFilter" title="Фильтр по дате">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="contentParentFilter">
                            <option value="">Все родители</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearContentFilters()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Табличное отображение содержимого -->
                <div class="table-responsive" id="tableViewContainer">
                    <table class="table table-sm table-hover" id="dictionaryContentTable">
                        <thead class="table-light">
                            <tr>
                                <th>Код</th>
                                <th>Название</th>
                                <th>Родитель</th>
                                <th>Дата начала</th>
                                <th>Дата окончания</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="dictionaryContentTableBody">
                            <!-- Здесь будет загружаться содержимое справочника -->
                        </tbody>
                    </table>
                </div>

                <!-- Древовидное отображение содержимого -->
                <div id="treeViewContainer" style="display: none;">
                    <!-- Кнопки управления деревом -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="expandAllTreeNodes()">
                                <i class="fas fa-expand-arrows-alt"></i> Раскрыть все
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="collapseAllTreeNodes()">
                                <i class="fas fa-compress-arrows-alt"></i> Свернуть все
                            </button>
                        </div>
                        <div class="text-muted small" id="treeNodeCount">
                            <!-- Здесь будет отображаться количество узлов -->
                        </div>
                    </div>

                    <div class="tree-container" id="dictionaryContentTree">
                        <!-- Здесь будет отображаться дерево справочника -->
                    </div>
                </div>

                <!-- Индикатор загрузки -->
                <div id="contentLoadingIndicator" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка содержимого справочника...</p>
                </div>

                <!-- Сообщение об ошибке -->
                <div id="contentErrorMessage" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="contentErrorText"></span>
                </div>

                <!-- Пагинация -->
                <nav aria-label="Навигация по содержимому" class="mt-3">
                    <ul class="pagination justify-content-center" id="contentPagination">
                        <!-- Пагинация будет добавляться динамически -->
                    </ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                    onclick="cleanupModalState()">Закрыть</button>
                <button type="button" class="btn btn-primary" id="addPositionBtn">Добавить позицию</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для форм -->
<div class="modal fade" id="modalContainer" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="modalContent">
                <!-- Содержимое модального окна будет загружаться динамически -->
            </div>
        </div>
    </div>
</div>

<script>
    let dictionaryToDelete = null;

    function createNewDictionary() {
        try {
            // Перенаправляем на страницу создания словаря
            window.location.href = '/dictionary/create/';
        } catch (error) {
            console.error('Ошибка при перенаправлении на страницу создания словаря:', error);
            alert('Ошибка при переходе на страницу создания словаря');
        }
    }

    function exportDictionaries(format = 'csv') {
        const table = document.querySelector('table');
        if (!table) {
            console.warn('Таблица не найдена для экспорта');
            alert('Таблица не найдена для экспорта');
            return;
        }

        let data, mimeType, filename;

        if (format === 'csv') {
            // Экспорт в CSV
            data = 'Код,Название,Описание,Статус,Тип,Дата создания\n';

            const rows = table.querySelectorAll('tbody tr');
            if (rows.length === 0) {
                console.warn('Нет строк для экспорта в CSV');
                alert('Нет данных для экспорта');
                return;
            }

            rows.forEach((row, index) => {
                // Проверяем, что это строка с данными (не заголовок) и она видима
                if (row.style.display !== 'none' && row.querySelector('td') && !row.querySelector('th')) {
                    try {
                        // Используем более надежные селекторы
                        const codeElement = row.querySelector('td:nth-child(1) .badge');
                        const nameElement = row.querySelector('td:nth-child(2) strong');
                        const descriptionElement = row.querySelector('td:nth-child(3) span');
                        const statusElement = row.querySelector('td:nth-child(4) .badge');
                        const typeElement = row.querySelector('td:nth-child(5) .badge');
                        const dateElement = row.querySelector('td:nth-child(6) small');

                        // Проверяем наличие элементов с более детальным логированием
                        const elements = {
                            code: codeElement,
                            name: nameElement,
                            description: descriptionElement,
                            status: statusElement,
                            type: typeElement,
                            date: dateElement
                        };

                        const missingElements = Object.entries(elements)
                            .filter(([key, element]) => !element)
                            .map(([key]) => key);

                        if (missingElements.length > 0) {
                            console.warn(`Не все элементы найдены в строке ${index} для экспорта CSV. Отсутствуют:`, missingElements);
                            console.log('Строка:', row.innerHTML);
                            return;
                        }

                        const code = codeElement.textContent.trim() || '';
                        const name = nameElement.textContent.trim() || '';
                        const description = descriptionElement.textContent.trim() || '';
                        const status = statusElement.textContent.trim() || '';
                        const type = typeElement.textContent.trim() || '';
                        const date = dateElement.textContent.trim() || '';

                        data += `"${code}","${name}","${description}","${status}","${type}","${date}"\n`;
                    } catch (error) {
                        console.warn(`Ошибка при обработке строки ${index} для экспорта CSV:`, error);
                        console.log('Строка:', row.innerHTML);
                    }
                }
            });

            mimeType = 'text/csv;charset=utf-8;';
            filename = 'словари_системы.csv';

        } else if (format === 'json') {
            // Экспорт в JSON
            const dictionaries = [];
            const rows = table.querySelectorAll('tbody tr');

            if (rows.length === 0) {
                console.warn('Нет строк для экспорта в JSON');
                alert('Нет данных для экспорта');
                return;
            }

            rows.forEach((row, index) => {
                // Проверяем, что это строка с данными (не заголовок) и она видима
                if (row.style.display !== 'none' && row.querySelector('td') && !row.querySelector('th')) {
                    try {
                        // Используем более надежные селекторы
                        const codeElement = row.querySelector('td:nth-child(1) .badge');
                        const nameElement = row.querySelector('td:nth-child(2) strong');
                        const descriptionElement = row.querySelector('td:nth-child(3) span');
                        const statusElement = row.querySelector('td:nth-child(4) .badge');
                        const typeElement = row.querySelector('td:nth-child(5) .badge');
                        const dateElement = row.querySelector('td:nth-child(6) small');

                        // Проверяем наличие элементов с более детальным логированием
                        const elements = {
                            code: codeElement,
                            name: nameElement,
                            description: descriptionElement,
                            status: statusElement,
                            type: typeElement,
                            date: dateElement
                        };

                        const missingElements = Object.entries(elements)
                            .filter(([key, element]) => !element)
                            .map(([key]) => key);

                        if (missingElements.length > 0) {
                            console.warn(`Не все элементы найдены в строке ${index} для экспорта JSON. Отсутствуют:`, missingElements);
                            console.log('Строка:', row.innerHTML);
                            return;
                        }

                        const code = codeElement.textContent.trim() || '';
                        const name = nameElement.textContent.trim() || '';
                        const description = descriptionElement.textContent.trim() || '';
                        const status = statusElement.textContent.trim() || '';
                        const type = typeElement.textContent.trim() || '';
                        const date = dateElement.textContent.trim() || '';

                        dictionaries.push({
                            code: code,
                            name: name,
                            description: description,
                            status: status,
                            type: type,
                            date: date
                        });
                    } catch (error) {
                        console.warn(`Ошибка при обработке строки ${index} для экспорта JSON:`, error);
                        console.log('Строка:', row.innerHTML);
                    }
                }
            });

            try {
                data = JSON.stringify(dictionaries, null, 2);
                mimeType = 'application/json;charset=utf-8;';
                filename = 'словари_системы.json';
            } catch (error) {
                console.error('Ошибка при создании JSON:', error);
                alert('Ошибка при создании JSON файла');
                return;
            }

        } else if (format === 'xlsx') {
            // Для Excel пока используем CSV (можно добавить библиотеку для создания XLSX)
            alert('Экспорт в Excel пока не поддерживается. Используйте CSV формат.');
            return;
        }

        // Создаем и скачиваем файл
        try {
            if (!data) {
                console.error('Нет данных для экспорта');
                alert('Нет данных для экспорта');
                return;
            }

            const blob = new Blob([data], { type: mimeType });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Очищаем URL объект
            URL.revokeObjectURL(url);

            console.log(`Файл ${filename} успешно экспортирован`);
        } catch (error) {
            console.error('Ошибка при создании и скачивании файла:', error);
            alert('Ошибка при экспорте файла');
        }
    }

    function refreshDictionaries() {
        try {
            // Показываем индикатор загрузки
            const refreshBtn = document.querySelector('button[onclick="refreshDictionaries()"]');
            if (!refreshBtn) {
                console.warn('Кнопка обновления не найдена');
                return;
            }

            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обновление...';
            refreshBtn.disabled = true;

            // Обновляем страницу для получения свежих данных
            // В будущем можно заменить на AJAX запрос
            setTimeout(() => {
                try {
                    location.reload();
                } catch (error) {
                    console.error('Ошибка при обновлении страницы:', error);
                    // Восстанавливаем кнопку при ошибке
                    refreshBtn.innerHTML = originalContent;
                    refreshBtn.disabled = false;
                }
            }, 500);
        } catch (error) {
            console.error('Ошибка при обновлении словарей:', error);
        }
    }

    function viewDictionaryContentOLD(dictionaryId, dictionaryName) {
        // Проверяем корректность параметров
        if (!dictionaryId || !dictionaryName) {
            console.error('Не переданы обязательные параметры для просмотра справочника');
            alert('Ошибка: не указаны параметры справочника');
            return;
        }

        // Принудительно очищаем состояние перед открытием нового модального окна
        console.log('Подготовка к открытию модального окна: очищаем предыдущее состояние');
        enableMainPageInteraction();
        cleanupModalState();

        // Проверяем, что модальное окно существует
        const modalElement = document.getElementById('dictionaryContentModal');
        if (!modalElement) {
            console.error('Модальное окно для просмотра справочника не найдено');
            alert('Ошибка: не найдено модальное окно');
            return;
        }

        // Показываем модальное окно с содержимым справочника
        const modal = new bootstrap.Modal(modalElement);

        // Добавляем обработчики событий для корректного закрытия
        modalElement.addEventListener('hidden.bs.modal', function () {
            console.log('Модальное окно закрыто, очищаем состояние');
            cleanupModalState();

            // Убеждаемся, что основная страница доступна
            setTimeout(() => {
                enableMainPageInteraction();
            }, 100);
        });

        // Добавляем обработчик для полного скрытия модального окна
        modalElement.addEventListener('transitionend', function (event) {
            if (event.propertyName === 'opacity' && !modalElement.classList.contains('show')) {
                console.log('Переход модального окна завершен, восстанавливаем взаимодействие');
                enableMainPageInteraction();
            }
        });

        // Добавляем обработчик для клавиши Escape
        modalElement.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                console.log('Нажата клавиша Escape, очищаем состояние');
                cleanupModalState();
            }
        });

        // Добавляем обработчик для клика вне модального окна
        modalElement.addEventListener('click', function (event) {
            if (event.target === modalElement) {
                console.log('Клик вне модального окна, очищаем состояние');
                cleanupModalState();
            }
        });

        modal.show();

        // Устанавливаем заголовок
        const titleElement = document.getElementById('dictionaryContentTitle');
        if (titleElement) {
            titleElement.textContent = `Содержимое справочника: ${dictionaryName}`;
        }

        // Преобразуем ID в число и загружаем содержимое справочника
        const numericId = parseInt(dictionaryId, 10);
        if (isNaN(numericId) || numericId <= 0) {
            console.error(`Некорректный ID справочника: ${dictionaryId}`);
            alert('Ошибка: некорректный ID справочника');
            return;
        }

        loadDictionaryContent(numericId);
    }

    function editDictionary(dictionaryId) {
        if (!dictionaryId) {
            console.error('Не передан ID справочника для редактирования');
            alert('Ошибка: не указан ID справочника');
            return;
        }

        try {
            // Перенаправляем на страницу редактирования словаря
            window.location.href = `/dictionary/${dictionaryId}/edit/`;
        } catch (error) {
            console.error('Ошибка при перенаправлении на страницу редактирования:', error);
            alert('Ошибка при переходе на страницу редактирования');
        }
    }

    function editDictionaryDescription(dictionaryId, dictionaryName) {
        if (!dictionaryId) {
            console.error('Не передан ID справочника для редактирования описания');
            alert('Ошибка: не указан ID справочника');
            return;
        }

        try {
            // Загружаем форму редактирования описания в модальное окно
            loadModalForm(`/dictionary/${dictionaryId}/edit-description/`);

            // Показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('modalContainer'));
            modal.show();

            console.log(`Открытие формы редактирования описания для справочника: ${dictionaryName} (ID: ${dictionaryId})`);

        } catch (error) {
            console.error('Ошибка при открытии формы редактирования описания:', error);
            alert('Ошибка при открытии формы редактирования описания');
        }
    }

    function viewDictionary(dictionaryId, dictionaryName) {
        if (!dictionaryId) {
            console.error('Не передан ID справочника для просмотра');
            alert('Ошибка: не указан ID справочника');
            return;
        }

        try {
            // Загружаем форму просмотра в модальное окно
            loadModalForm(`/dictionary/${dictionaryId}/view-modal/`);

            // Показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('modalContainer'));
            modal.show();

            console.log(`Открытие формы просмотра для справочника: ${dictionaryName} (ID: ${dictionaryId})`);

        } catch (error) {
            console.error('Ошибка при открытии формы просмотра:', error);
            alert('Ошибка при открытии формы просмотра');
        }
    }

    function viewDictionaryContent(dictionaryId, dictionaryName) {
        if (!dictionaryId) {
            console.error('Не передан ID справочника для просмотра содержимого');
            alert('Ошибка: не указан ID справочника');
            return;
        }

        try {
            // Перенаправляем на страницу с таблицей содержимого справочника
            const url = `/dictionary/${dictionaryId}/table/`;
            console.log(`Переход к содержимому справочника: ${dictionaryName} (ID: ${dictionaryId}) по URL: ${url}`);
            window.location.href = url;

        } catch (error) {
            console.error('Ошибка при открытии содержимого справочника:', error);
            alert('Ошибка при открытии содержимого справочника');
        }
    }

    function loadModalForm(url) {
        console.log('Загрузка модальной формы по URL:', url);

        // Добавляем эффект загрузки
        const modalContent = document.getElementById('modalContent');
        if (!modalContent) {
            console.error('Элемент modalContent не найден');
            return;
        }

        modalContent.innerHTML = `
        <div class="modal-header">
            <h5 class="modal-title">Загрузка...</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body loading">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-3">Загрузка формы...</p>
            </div>
        </div>
    `;

        console.log('Отправка fetch запроса к:', url);

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                console.log('Получен ответ от сервера:', {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                console.log('Получен HTML ответ, длина:', html.length);
                console.log('Первые 200 символов HTML:', html.substring(0, 200));

                // Анимация появления контента
                modalContent.style.opacity = '0';
                modalContent.innerHTML = html;

                setTimeout(() => {
                    modalContent.style.opacity = '1';
                    modalContent.style.transition = 'opacity 0.3s ease';
                }, 100);

                console.log('Форма успешно загружена');
            })
            .catch(error => {
                console.error('Ошибка загрузки формы:', error);
                console.error('Полная информация об ошибке:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });

                modalContent.innerHTML = `
            <div class="modal-header">
                <h5 class="modal-title">Ошибка загрузки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Не удалось загрузить форму</strong><br>
                    <small class="text-muted">${error.message}</small>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>
                        Обновить страницу
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="console.log('URL для отладки:', '${url}')">
                        <i class="fas fa-bug me-1"></i>
                        Отладка
                    </button>
                </div>
            </div>
        `;
            });
    }

    function deleteDictionary(dictionaryId, dictionaryName) {
        if (!dictionaryId || !dictionaryName) {
            console.error('Не переданы обязательные параметры для удаления справочника:', { dictionaryId, dictionaryName });
            alert('Ошибка: не указаны параметры справочника');
            return;
        }

        try {
            dictionaryToDelete = dictionaryId;

            const deleteNameElement = document.getElementById('deleteDictionaryName');
            if (deleteNameElement) {
                deleteNameElement.textContent = dictionaryName;
            }

            // Показываем модальное окно подтверждения
            const modalElement = document.getElementById('deleteConfirmModal');
            if (!modalElement) {
                console.error('Модальное окно подтверждения удаления не найдено');
                alert('Ошибка: не найдено модальное окно подтверждения');
                return;
            }

            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } catch (error) {
            console.error('Ошибка при показе модального окна удаления:', error);
            alert('Ошибка при показе окна подтверждения удаления');
        }
    }

    // Функция очистки состояния модального окна
    function cleanupModalState() {
        console.log('Очистка состояния модального окна');

        try {
            // Сбрасываем глобальные переменные
            currentDictionaryId = null;
            currentDictionaryContent = [];

            // Очищаем содержимое таблицы
            const tableBody = document.getElementById('dictionaryContentTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
            }

            // Очищаем содержимое дерева
            const treeContainer = document.getElementById('dictionaryContentTree');
            if (treeContainer) {
                treeContainer.innerHTML = '';
            }

            // Сбрасываем режим отображения на табличный
            currentViewMode = 'table';
            const tableBtn = document.getElementById('tableViewMode');
            const treeBtn = document.getElementById('treeViewMode');
            if (tableBtn) tableBtn.checked = true;
            if (treeBtn) treeBtn.checked = false;

            // Показываем таблицу и скрываем дерево
            const tableContainer = document.getElementById('tableViewContainer');
            const treeViewContainer = document.getElementById('treeViewContainer');
            if (tableContainer) tableContainer.style.display = 'block';
            if (treeViewContainer) treeViewContainer.style.display = 'none';

            // Скрываем индикатор загрузки
            const loadingIndicator = document.getElementById('contentLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }

            // Скрываем сообщение об ошибке
            const errorMessage = document.getElementById('contentErrorMessage');
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }

            // Очищаем фильтры
            const searchInput = document.getElementById('contentSearchInput');
            const dateFilter = document.getElementById('contentDateFilter');
            const parentFilter = document.getElementById('contentParentFilter');

            if (searchInput) searchInput.value = '';
            if (dateFilter) dateFilter.value = '';
            if (parentFilter) {
                parentFilter.innerHTML = '<option value="">Все родители</option>';
            }

            // Очищаем заголовок
            const titleElement = document.getElementById('dictionaryContentTitle');
            if (titleElement) {
                titleElement.textContent = 'Содержимое справочника';
            }

            // Очищаем бейджи
            const codeBadge = document.getElementById('dictionaryContentCode');
            const statusBadge = document.getElementById('dictionaryContentStatus');
            const typeBadge = document.getElementById('dictionaryContentType');

            if (codeBadge) codeBadge.textContent = '';
            if (statusBadge) statusBadge.textContent = '';
            if (typeBadge) typeBadge.textContent = '';

            console.log('Состояние модального окна очищено');

        } catch (error) {
            console.error('Ошибка при очистке состояния модального окна:', error);
        }
    }

    // Функция принудительного закрытия модального окна
    function forceCloseModal() {
        try {
            const modalElement = document.getElementById('dictionaryContentModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
            cleanupModalState();
            console.log('Модальное окно принудительно закрыто');
        } catch (error) {
            console.error('Ошибка при принудительном закрытии модального окна:', error);
        }
    }

    // Функция восстановления взаимодействия с основной страницей
    function enableMainPageInteraction() {
        try {
            console.log('Восстанавливаем взаимодействие с основной страницей');

            // Убираем все возможные блокировки
            const modalBackdrops = document.querySelectorAll('.modal-backdrop');
            modalBackdrops.forEach(backdrop => {
                backdrop.remove();
            });

            // Убираем класс modal-open с body
            document.body.classList.remove('modal-open');

            // Убираем padding-right с body
            document.body.style.paddingRight = '';

            // Убираем overflow: hidden с body
            document.body.style.overflow = '';

            // Убираем position: fixed с body
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.width = '';
            document.body.style.height = '';

            // Убираем все inline стили, которые могли быть добавлены Bootstrap
            const body = document.body;
            body.removeAttribute('style');

            console.log('Взаимодействие с основной страницей восстановлено');

        } catch (error) {
            console.error('Ошибка при восстановлении взаимодействия с основной страницей:', error);
        }
    }

    // Функция проверки взаимодействия с основной страницей
    function checkPageInteraction() {
        try {
            // Проверяем, есть ли модальные окна, которые должны быть закрыты
            const modal = document.getElementById('dictionaryContentModal');
            const hasModalOpen = document.body.classList.contains('modal-open');
            const hasBackdrop = document.querySelector('.modal-backdrop');

            // Если нет открытых модальных окон, но есть блокировки - убираем их
            if (!modal || !modal.classList.contains('show')) {
                if (hasModalOpen || hasBackdrop) {
                    console.log('Обнаружена блокировка без открытого модального окна, восстанавливаем взаимодействие');
                    enableMainPageInteraction();
                }
            }

            // Проверяем, не заблокирован ли скролл
            if (document.body.style.overflow === 'hidden' && (!modal || !modal.classList.contains('show'))) {
                console.log('Обнаружена блокировка скролла без открытого модального окна, восстанавливаем');
                enableMainPageInteraction();
            }

        } catch (error) {
            console.warn('Ошибка при проверке взаимодействия с основной страницей:', error);
        }
    }

    // ===== ФУНКЦИИ ДЛЯ ПЕРЕКЛЮЧЕНИЯ РЕЖИМОВ ОТОБРАЖЕНИЯ =====

    // Переключение на табличный вид
    function switchToTableView() {
        try {
            console.log('Переключение на табличный вид');

            currentViewMode = 'table';

            // Показываем таблицу
            const tableContainer = document.getElementById('tableViewContainer');
            const treeContainer = document.getElementById('treeViewContainer');

            if (tableContainer) tableContainer.style.display = 'block';
            if (treeContainer) treeContainer.style.display = 'none';

            // Обновляем состояние кнопок
            const tableBtn = document.getElementById('tableViewMode');
            const treeBtn = document.getElementById('treeViewMode');

            if (tableBtn) tableBtn.checked = true;
            if (treeBtn) treeBtn.checked = false;

            console.log('Переключение на табличный вид завершено');

        } catch (error) {
            console.error('Ошибка при переключении на табличный вид:', error);
        }
    }

    // Переключение на древовидный вид
    function switchToTreeView() {
        try {
            console.log('Переключение на древовидный вид');

            currentViewMode = 'tree';

            // Показываем дерево
            const tableContainer = document.getElementById('tableViewContainer');
            const treeContainer = document.getElementById('treeViewContainer');

            if (tableContainer) tableContainer.style.display = 'none';
            if (treeContainer) treeContainer.style.display = 'block';

            // Обновляем состояние кнопок
            const tableBtn = document.getElementById('tableViewMode');
            const treeBtn = document.getElementById('treeViewMode');

            if (tableBtn) tableBtn.checked = false;
            if (treeBtn) treeBtn.checked = true;

            // Перестраиваем дерево с текущими данными
            if (currentDictionaryContent && currentDictionaryContent.length > 0) {
                displayDictionaryTree(currentDictionaryContent);
            }

            console.log('Переключение на древовидный вид завершено');

        } catch (error) {
            console.error('Ошибка при переключении на древовидный вид:', error);
        }
    }

    // ===== ФУНКЦИИ ДЛЯ РАБОТЫ С ДЕРЕВОМ =====

    // Построение дерева из плоского массива данных
    function buildTree(data) {
        try {
            console.log('Построение дерева из данных:', data.length, 'элементов');

            // Создаем карту для быстрого поиска элементов по ID
            const itemsMap = new Map();
            const rootItems = [];

            // Сначала создаем все узлы
            data.forEach(item => {
                const treeNode = {
                    id: item.id,
                    parent_id: item.parent_id,
                    code: getAttributeValue(item.attrs, 'Код') || item.code || '',
                    name: getAttributeValue(item.attrs, 'Наименование') || item.name || '',
                    start_date: item.start_date,
                    end_date: item.end_date,
                    children: [],
                    originalData: item
                };
                itemsMap.set(item.id, treeNode);
            });

            // Теперь строим иерархию
            itemsMap.forEach(node => {
                if (node.parent_id === null || node.parent_id === undefined) {
                    // Корневой элемент
                    rootItems.push(node);
                } else {
                    // Дочерний элемент
                    const parent = itemsMap.get(node.parent_id);
                    if (parent) {
                        parent.children.push(node);
                    } else {
                        // Родитель не найден, считаем корневым
                        rootItems.push(node);
                    }
                }
            });

            console.log('Дерево построено:', rootItems.length, 'корневых элементов');
            return rootItems;

        } catch (error) {
            console.error('Ошибка при построении дерева:', error);
            return [];
        }
    }

    // Получение значения атрибута из массива атрибутов
    function getAttributeValue(attrs, attributeName) {
        if (!attrs || !Array.isArray(attrs)) return null;

        const attribute = attrs.find(attr => attr.name === attributeName);
        return attribute ? attribute.value : null;
    }

    // Отображение дерева
    function displayDictionaryTree(data) {
        try {
            console.log('Отображение дерева справочника');

            const treeContainer = document.getElementById('dictionaryContentTree');
            if (!treeContainer) {
                console.error('Контейнер для дерева не найден');
                return;
            }

            // Очищаем контейнер
            treeContainer.innerHTML = '';

            if (!data || data.length === 0) {
                treeContainer.innerHTML = '<div class="tree-empty">Справочник пуст</div>';
                return;
            }

            // Строим дерево
            const treeData = buildTree(data);

            if (treeData.length === 0) {
                treeContainer.innerHTML = '<div class="tree-empty">Не удалось построить дерево</div>';
                return;
            }

            // Создаем корневой узел
            const rootNode = document.createElement('ul');
            rootNode.className = 'tree-node tree-root';

            // Добавляем все корневые элементы
            treeData.forEach(item => {
                const treeItem = createTreeItem(item);
                rootNode.appendChild(treeItem);
            });

            treeContainer.appendChild(rootNode);

            // Обновляем счетчик узлов
            updateTreeNodeCount(data.length, treeData.length);

            console.log('Дерево отображено успешно');

        } catch (error) {
            console.error('Ошибка при отображении дерева:', error);

            const treeContainer = document.getElementById('dictionaryContentTree');
            if (treeContainer) {
                treeContainer.innerHTML = '<div class="tree-empty">Ошибка при построении дерева</div>';
            }
        }
    }

    // Создание элемента дерева
    function createTreeItem(item) {
        const li = document.createElement('li');
        li.className = 'tree-item';

        const content = document.createElement('div');
        content.className = 'tree-item-content';

        // Кнопка раскрытия/свертывания
        const toggle = document.createElement('button');
        toggle.className = item.children.length > 0 ? 'tree-toggle collapsed' : 'tree-toggle leaf';
        toggle.onclick = () => toggleTreeItem(li, toggle);

        // Информация об элементе
        const info = document.createElement('div');
        info.className = 'tree-item-info';

        const main = document.createElement('div');
        main.className = 'tree-item-main';

        const title = document.createElement('div');
        title.className = 'tree-item-title';
        title.textContent = item.name || 'Без названия';

        const code = document.createElement('div');
        code.className = 'tree-item-code';
        code.textContent = item.code || '';

        main.appendChild(title);
        if (item.code) main.appendChild(code);

        // Метаинформация
        const meta = document.createElement('div');
        meta.className = 'tree-item-meta';

        if (item.start_date) {
            const startDate = document.createElement('span');
            startDate.textContent = `С: ${formatDate(item.start_date)}`;
            meta.appendChild(startDate);
        }

        if (item.end_date) {
            const endDate = document.createElement('span');
            endDate.textContent = `До: ${formatDate(item.end_date)}`;
            meta.appendChild(endDate);
        }

        if (meta.children.length > 0) {
            main.appendChild(meta);
        }

        // Действия
        const actions = document.createElement('div');
        actions.className = 'tree-item-actions';

        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn btn-sm btn-outline-primary me-1';
        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
        viewBtn.title = 'Просмотр';
        viewBtn.onclick = (e) => {
            e.stopPropagation();
            viewPosition(item.originalData);
        };

        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline-secondary me-1';
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'Редактировать';
        editBtn.onclick = (e) => {
            e.stopPropagation();
            editPosition(item.originalData);
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'Удалить';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePosition(item.originalData);
        };

        actions.appendChild(viewBtn);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        info.appendChild(main);
        info.appendChild(actions);

        content.appendChild(toggle);
        content.appendChild(info);

        li.appendChild(content);

        // Дочерние элементы
        if (item.children.length > 0) {
            const childrenContainer = document.createElement('ul');
            childrenContainer.className = 'tree-children tree-node';

            item.children.forEach(child => {
                const childItem = createTreeItem(child);
                childrenContainer.appendChild(childItem);
            });

            li.appendChild(childrenContainer);
        }

        return li;
    }

    // Переключение состояния узла дерева
    function toggleTreeItem(item, toggle) {
        try {
            const children = item.querySelector('.tree-children');
            if (!children) return;

            if (toggle.classList.contains('collapsed')) {
                // Раскрываем
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
                children.classList.add('expanded');
            } else {
                // Свертываем
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
                children.classList.remove('expanded');
            }
        } catch (error) {
            console.error('Ошибка при переключении узла дерева:', error);
        }
    }

    // Раскрытие всех узлов дерева
    function expandAllTreeNodes() {
        try {
            console.log('Раскрытие всех узлов дерева');

            const treeContainer = document.getElementById('dictionaryContentTree');
            if (!treeContainer) return;

            const toggles = treeContainer.querySelectorAll('.tree-toggle:not(.leaf)');
            const children = treeContainer.querySelectorAll('.tree-children');

            toggles.forEach(toggle => {
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            });

            children.forEach(child => {
                child.classList.add('expanded');
            });

            console.log('Все узлы дерева раскрыты');

        } catch (error) {
            console.error('Ошибка при раскрытии всех узлов дерева:', error);
        }
    }

    // Сворачивание всех узлов дерева
    function collapseAllTreeNodes() {
        try {
            console.log('Сворачивание всех узлов дерева');

            const treeContainer = document.getElementById('dictionaryContentTree');
            if (!treeContainer) return;

            const toggles = treeContainer.querySelectorAll('.tree-toggle:not(.leaf)');
            const children = treeContainer.querySelectorAll('.tree-children');

            toggles.forEach(toggle => {
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            });

            children.forEach(child => {
                child.classList.remove('expanded');
            });

            console.log('Все узлы дерева свернуты');

        } catch (error) {
            console.error('Ошибка при сворачивании всех узлов дерева:', error);
        }
    }

    // Обновление счетчика узлов дерева
    function updateTreeNodeCount(totalNodes, rootNodes) {
        try {
            const countElement = document.getElementById('treeNodeCount');
            if (countElement) {
                countElement.textContent = `Всего узлов: ${totalNodes}, корневых: ${rootNodes}`;
            }
        } catch (error) {
            console.error('Ошибка при обновлении счетчика узлов:', error);
        }
    }

    // Функция фильтрации словарей
    function filterDictionaries() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const typeFilter = document.getElementById('typeFilter');

        if (!searchInput || !statusFilter || !typeFilter) {
            console.warn('Не все элементы фильтров найдены');
            return;
        }

        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const typeValue = typeFilter.value;

        const tbody = document.querySelector('tbody');
        if (!tbody) {
            console.warn('Таблица не найдена');
            return;
        }

        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach((row, index) => {
            try {
                // Проверяем, что это строка с данными (не заголовок)
                if (!row.querySelector('td') || row.querySelector('th')) {
                    return; // Пропускаем заголовки и пустые строки
                }

                const nameElement = row.querySelector('td:nth-child(2) strong');
                const codeElement = row.querySelector('td:nth-child(1) .badge');
                const statusElement = row.querySelector('td:nth-child(4) .badge');
                const typeElement = row.querySelector('td:nth-child(5) .badge');

                // Проверяем наличие элементов с более детальным логированием
                const elements = {
                    name: nameElement,
                    code: codeElement,
                    status: statusElement,
                    type: typeElement
                };

                const missingElements = Object.entries(elements)
                    .filter(([key, element]) => !element)
                    .map(([key]) => key);

                if (missingElements.length > 0) {
                    console.warn(`Не все элементы найдены в строке ${index}. Отсутствуют:`, missingElements);
                    console.log('Строка:', row.innerHTML);
                    return;
                }

                const name = nameElement.textContent.toLowerCase();
                const code = codeElement.textContent.toLowerCase();
                const status = statusElement.textContent.toLowerCase();
                const type = typeElement.textContent.toLowerCase();

                let showRow = true;

                // Поиск по названию или коду
                if (searchTerm && !name.includes(searchTerm) && !code.includes(searchTerm)) {
                    showRow = false;
                }

                // Фильтр по статусу
                if (statusValue && status !== statusValue) {
                    showRow = false;
                }

                // Фильтр по типу
                if (typeValue && type !== typeValue) {
                    showRow = false;
                }

                if (showRow) {
                    try {
                        row.style.display = '';
                        visibleCount++;
                    } catch (error) {
                        console.warn(`Ошибка при показе строки ${index}:`, error);
                    }
                } else {
                    try {
                        row.style.display = 'none';
                    } catch (error) {
                        console.warn(`Ошибка при скрытии строки ${index}:`, error);
                    }
                }
            } catch (error) {
                console.warn(`Ошибка при обработке строки ${index}:`, error);
                console.log('Строка:', row.innerHTML);
            }
        });

        // Обновляем счетчик видимых словарей
        const totalBadge = document.querySelector('.badge.bg-primary');
        if (totalBadge) {
            totalBadge.textContent = `Показано: ${visibleCount}`;
        }
    }

    // Обработчик подтверждения удаления
    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (dictionaryToDelete && dictionaryToDelete !== null && dictionaryToDelete !== undefined) {
            // Здесь можно добавить AJAX запрос для удаления
            // Пока просто перенаправляем на страницу удаления
            window.location.href = `/dictionaries/${dictionaryToDelete}/delete/`;
        } else {
            console.error('Не выбран справочник для удаления');
            alert('Ошибка: не выбран справочник для удаления');
        }
    });

    // Обновляем страницу каждые 30 секунд для синхронизации данных
    setInterval(function () {
        try {
            // Можно добавить AJAX запрос для обновления списка без перезагрузки страницы
            // Пока просто логируем для отладки
            console.log('Автообновление: проверка новых данных...');
        } catch (error) {
            console.error('Ошибка при автообновлении:', error);
        }
    }, 30000);

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        // Добавляем обработчики для клавиш
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function (e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    filterDictionaries();
                }
            });
        }

        // Добавляем обработчики для кликабельных элементов (код и название справочника)
        document.querySelectorAll('.clickable-code, .clickable-name').forEach(element => {
            element.addEventListener('click', function () {
                const dictId = this.getAttribute('data-dict-id');
                const dictName = this.getAttribute('data-dict-name');
                if (dictId && dictName) {
                    viewDictionaryContent(dictId, dictName);
                } else {
                    console.error('Не переданы обязательные параметры для просмотра содержимого справочника');
                }
            });
        });

        document.querySelectorAll('.edit-dict-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const dictId = this.getAttribute('data-dict-id');
                if (dictId) {
                    editDictionary(dictId);
                } else {
                    console.error('Не передан ID справочника для редактирования');
                }
            });
        });

        document.querySelectorAll('.delete-dict-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const dictId = this.getAttribute('data-dict-name');
                const dictName = this.getAttribute('data-dict-name');
                if (dictId && dictName) {
                    deleteDictionary(dictId, dictName);
                } else {
                    console.error('Не переданы обязательные параметры для удаления справочника');
                }
            });
        });

        document.querySelectorAll('.view-dict-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const dictId = this.getAttribute('data-dict-id');
                const dictName = this.getAttribute('data-dict-name');
                if (dictId) {
                    viewDictionary(dictId, dictName);
                } else {
                    console.error('Не передан ID справочника для просмотра');
                }
            });
        });

        // Добавляем обработчики для сортировки
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', function () {
                const sortBy = this.getAttribute('data-sort');
                if (sortBy) {
                    sortTable(sortBy, this);
                } else {
                    console.warn('Не указан атрибут data-sort для сортировки');
                }
            });
        });

        // Показываем все словари при загрузке
        filterDictionaries();

        // Подсчитываем статистику
        calculateStatistics();
    });

    // Функция сортировки таблицы
    function sortTable(sortBy, headerElement) {
        if (!sortBy || !headerElement) {
            console.error('Не переданы обязательные параметры для сортировки:', { sortBy, headerElement });
            return;
        }

        const table = document.querySelector('table');
        if (!table) {
            console.warn('Таблица не найдена');
            return;
        }

        const tbody = table.querySelector('tbody');
        if (!tbody) {
            console.warn('Тело таблицы не найдено');
            return;
        }

        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) {
            console.warn('Нет строк для сортировки');
            return;
        }

        // Определяем направление сортировки
        const isAsc = !headerElement.classList.contains('sort-asc');

        // Убираем все классы сортировки
        document.querySelectorAll('.sortable').forEach(th => {
            if (th && th.classList) {
                th.classList.remove('sort-asc', 'sort-desc');
            }
        });

        // Добавляем класс для текущего заголовка
        if (headerElement && headerElement.classList) {
            headerElement.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
        }

        // Сортируем строки
        rows.sort((a, b) => {
            let aValue, bValue;

            try {
                switch (sortBy) {
                    case 'code':
                        const aCodeElement = a.querySelector('td:nth-child(1) .badge');
                        const bCodeElement = b.querySelector('td:nth-child(1) .badge');
                        aValue = aCodeElement ? aCodeElement.textContent : '';
                        bValue = bCodeElement ? bCodeElement.textContent : '';
                        break;
                    case 'name':
                        const aNameElement = a.querySelector('td:nth-child(2) strong');
                        const bNameElement = b.querySelector('td:nth-child(2) strong');
                        aValue = aNameElement ? aNameElement.textContent : '';
                        bValue = bNameElement ? bNameElement.textContent : '';
                        break;
                    case 'description':
                        const aDescElement = a.querySelector('td:nth-child(3) span');
                        const bDescElement = b.querySelector('td:nth-child(3) span');
                        aValue = aDescElement ? aDescElement.textContent : '';
                        bValue = bDescElement ? bDescElement.textContent : '';
                        break;
                    case 'status':
                        const aStatusElement = a.querySelector('td:nth-child(4) .badge');
                        const bStatusElement = b.querySelector('td:nth-child(4) .badge');
                        aValue = aStatusElement ? aStatusElement.textContent : '';
                        bValue = bStatusElement ? bStatusElement.textContent : '';
                        break;
                    case 'type':
                        const aTypeElement = a.querySelector('td:nth-child(5) .badge');
                        const bTypeElement = b.querySelector('td:nth-child(5) .badge');
                        aValue = aTypeElement ? aTypeElement.textContent : '';
                        bValue = bTypeElement ? bTypeElement.textContent : '';
                        break;
                    case 'date':
                        const aDateElement = a.querySelector('td:nth-child(6) small');
                        const bDateElement = b.querySelector('td:nth-child(6) small');
                        aValue = aDateElement ? aDateElement.textContent : '';
                        bValue = bDateElement ? bDateElement.textContent : '';
                        break;
                    default:
                        console.warn(`Неизвестный тип сортировки: ${sortBy}`);
                        return 0;
                }
            } catch (error) {
                console.warn(`Ошибка при получении значений для сортировки:`, error);
                return 0;
            }

            if (aValue < bValue) return isAsc ? -1 : 1;
            if (aValue > bValue) return isAsc ? 1 : -1;
            return 0;
        });

        // Перестраиваем таблицу
        try {
            rows.forEach((row, index) => {
                if (row && tbody) {
                    try {
                        tbody.appendChild(row);
                    } catch (error) {
                        console.warn(`Ошибка при добавлении строки ${index} в таблицу:`, error);
                    }
                }
            });
        } catch (error) {
            console.error('Ошибка при перестройке таблицы:', error);
        }
    }

    // Функция подсчета статистики
    function calculateStatistics() {
        const table = document.querySelector('table');
        if (!table) {
            console.warn('Таблица не найдена для подсчета статистики');
            return;
        }

        const tbody = table.querySelector('tbody');
        if (!tbody) {
            console.warn('Тело таблицы не найдено для подсчета статистики');
            return;
        }

        const rows = tbody.querySelectorAll('tr');
        if (rows.length === 0) {
            console.warn('Нет строк для подсчета статистики');
            return;
        }

        let activeCount = 0;
        let draftCount = 0;
        let classifierCount = 0;

        rows.forEach((row, index) => {
            try {
                // Проверяем, что это строка с данными (не заголовок)
                if (!row.querySelector('td') || row.querySelector('th')) {
                    return; // Пропускаем заголовки и пустые строки
                }

                const statusElement = row.querySelector('td:nth-child(4) .badge');
                const typeElement = row.querySelector('td:nth-child(5) .badge');

                // Проверяем наличие элементов с более детальным логированием
                const elements = {
                    status: statusElement,
                    type: typeElement
                };

                const missingElements = Object.entries(elements)
                    .filter(([key, element]) => !element)
                    .map(([key]) => key);

                if (missingElements.length > 0) {
                    console.warn(`Не все элементы найдены в строке ${index} для статистики. Отсутствуют:`, missingElements);
                    console.log('Строка:', row.innerHTML);
                    return;
                }

                const status = statusElement.textContent.toLowerCase();
                const type = typeElement.textContent.toLowerCase();

                if (status === 'активный' || status === 'active') {
                    activeCount++;
                } else if (status === 'черновик' || status === 'draft') {
                    draftCount++;
                }

                if (type === 'классификатор' || type === 'classifier') {
                    classifierCount++;
                }

                // Дополнительная проверка корректности подсчета
                if (activeCount < 0 || draftCount < 0 || classifierCount < 0) {
                    console.warn(`Некорректные значения счетчиков в строке ${index}:`, { activeCount, draftCount, classifierCount });
                }
            } catch (error) {
                console.warn(`Ошибка при обработке строки ${index} для статистики:`, error);
                console.log('Строка:', row.innerHTML);
            }
        });

        // Обновляем статистику
        const activeElement = document.getElementById('activeCount');
        const draftElement = document.getElementById('draftCount');
        const classifierElement = document.getElementById('classifierCount');

        try {
            if (activeElement) activeElement.textContent = activeCount;
            if (draftElement) draftElement.textContent = draftCount;
            if (classifierElement) classifierElement.textContent = classifierCount;

            console.log(`Статистика обновлена: Активных: ${activeCount}, Черновиков: ${draftCount}, Классификаторов: ${classifierCount}`);
        } catch (error) {
            console.error('Ошибка при обновлении статистики:', error);
        }
    }

    // Функция показа сообщений
    function showMessage(type, text, duration = 5000) {
        if (!type || !text) {
            console.warn('Не переданы обязательные параметры для showMessage:', { type, text });
            return;
        }

        const messageId = type + 'Message';
        const messageElement = document.getElementById(messageId);
        const textElement = document.getElementById(type + 'Text');

        if (!messageElement || !textElement) {
            console.warn(`Элементы сообщения не найдены: ${messageId}, ${type}Text`);
            return;
        }

        try {
            textElement.textContent = text;
            messageElement.style.display = 'block';

            // Автоматически скрываем сообщение
            setTimeout(() => {
                if (messageElement) {
                    messageElement.style.display = 'none';
                }
            }, duration);
        } catch (error) {
            console.error('Ошибка при показе сообщения:', error);
        }
    }

    // Функция скрытия всех сообщений
    function hideAllMessages() {
        const messageTypes = ['error', 'info', 'success', 'warning'];
        messageTypes.forEach(type => {
            const messageElement = document.getElementById(type + 'Message');
            if (messageElement) {
                try {
                    messageElement.style.display = 'none';
                } catch (error) {
                    console.warn(`Ошибка при скрытии сообщения ${type}:`, error);
                }
            }
        });
    }

    // Функция валидации данных
    function validateDictionaryData(dictionary) {
        if (!dictionary || typeof dictionary !== 'object') {
            console.error('Некорректные данные для валидации:', dictionary);
            return ['Некорректные данные для валидации'];
        }

        const errors = [];

        if (!dictionary.name || dictionary.name.trim() === '') {
            errors.push('Название словаря обязательно');
        }

        if (!dictionary.code || dictionary.code.trim() === '') {
            errors.push('Код словаря обязателен');
        }

        return errors;
    }

    // Функция форматирования даты
    function formatDate(dateString) {
        if (!dateString || dateString === null || dateString === undefined) {
            return '-';
        }

        try {
            const date = new Date(dateString);

            // Проверяем, что дата корректная
            if (isNaN(date.getTime())) {
                console.warn(`Некорректная дата: ${dateString}`);
                return dateString || '-';
            }

            return date.toLocaleDateString('ru-RU');
        } catch (e) {
            console.warn(`Ошибка форматирования даты ${dateString}:`, e);
            return dateString || '-';
        }
    }

    // Функция очистки фильтров
    function clearFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const typeFilter = document.getElementById('typeFilter');

        if (searchInput) searchInput.value = '';
        if (statusFilter) statusFilter.value = '';
        if (typeFilter) typeFilter.value = '';

        filterDictionaries();
    }

    // Функция показа статистики
    function showStatistics() {
        const totalElement = document.querySelector('.badge.bg-primary');
        const activeElement = document.getElementById('activeCount');
        const draftElement = document.getElementById('draftCount');
        const classifierElement = document.getElementById('classifierCount');

        const stats = {
            total: totalElement ? totalElement.textContent : 'неизвестно',
            active: activeElement ? activeElement.textContent : 'неизвестно',
            draft: draftElement ? draftElement.textContent : 'неизвестно',
            classifier: classifierElement ? classifierElement.textContent : 'неизвестно'
        };

        const message = `Статистика словарей:\n` +
            `Всего: ${stats.total}\n` +
            `Активных: ${stats.active}\n` +
            `Черновиков: ${stats.draft}\n` +
            `Классификаторов: ${stats.classifier}`;

        alert(message);
    }

    // Функция показа настроек
    function showSettings() {
        const settings = {
            'Автообновление': 'Включено (каждые 30 сек)',
            'Сортировка по умолчанию': 'По названию',
            'Экспорт по умолчанию': 'CSV',
            'Показывать описания': 'Да',
            'Цветовая схема': 'Стандартная'
        };

        try {
            let message = 'Текущие настройки:\n\n';
            for (const [key, value] of Object.entries(settings)) {
                if (key && value) {
                    message += `${key}: ${value}\n`;
                }
            }
            message += '\nДля изменения настроек обратитесь к администратору системы.';

            alert(message);
        } catch (error) {
            console.error('Ошибка при показе настроек:', error);
            alert('Ошибка при загрузке настроек');
        }
    }

    // Функция для проверки доступности API
    function checkApiAvailability() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const infoMessage = document.getElementById('infoMessage');
        const successMessage = document.getElementById('successMessage');
        const warningMessage = document.getElementById('warningMessage');

        // Проверяем, что все элементы найдены
        if (!loadingIndicator || !errorMessage || !infoMessage || !successMessage || !warningMessage) {
            console.error('Не все элементы для проверки API найдены');
            return;
        }

        loadingIndicator.style.display = 'block';
        errorMessage.style.display = 'none';
        infoMessage.style.display = 'none';
        successMessage.style.display = 'none';
        warningMessage.style.display = 'none';

        fetch('/api/v1/check-api-availability/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (loadingIndicator) loadingIndicator.style.display = 'none';

                if (!data || typeof data !== 'object') {
                    console.error('Некорректный ответ API:', data);
                    if (errorMessage) errorMessage.style.display = 'block';
                    return;
                }

                if (data.status === 'available') {
                    if (successMessage) successMessage.style.display = 'block';
                    if (infoMessage) infoMessage.style.display = 'none';
                    if (warningMessage) warningMessage.style.display = 'none';
                    showMessage('success', 'API доступен. Последнее обновление: ' + (data.last_updated || 'неизвестно'));
                } else {
                    if (errorMessage) errorMessage.style.display = 'block';
                    if (infoMessage) infoMessage.style.display = 'none';
                    if (successMessage) successMessage.style.display = 'none';
                    if (warningMessage) warningMessage.style.display = 'none';
                    showMessage('error', 'API недоступен. Статус: ' + (data.status || 'неизвестно') + ' (последнее обновление: ' + (data.last_updated || 'неизвестно') + ')');
                }
            })
            .catch(error => {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (errorMessage) errorMessage.style.display = 'block';
                if (infoMessage) infoMessage.style.display = 'none';
                if (successMessage) successMessage.style.display = 'none';
                if (warningMessage) warningMessage.style.display = 'none';
                showMessage('error', 'Произошла ошибка при проверке доступности API: ' + error.message);
            });
    }

    // Функция для переключения отображения отладочной информации
    function toggleDebugInfo() {
        const debugInfoDiv = document.getElementById('debugInfo');
        if (debugInfoDiv) {
            debugInfoDiv.style.display = debugInfoDiv.style.display === 'block' ? 'none' : 'block';
        }
    }

    // ===== ФУНКЦИИ ДЛЯ РАБОТЫ С СОДЕРЖИМЫМ СПРАВОЧНИКА =====

    let currentDictionaryId = null;
    let currentDictionaryContent = [];
    let currentViewMode = 'table'; // 'table' или 'tree'

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        // Сбрасываем состояние при загрузке страницы
        currentDictionaryId = null;
        currentDictionaryContent = [];

        // Добавляем глобальный обработчик для восстановления взаимодействия
        // в случае зависания модального окна
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('dictionaryContentModal');
                if (modal && modal.classList.contains('show')) {
                    console.log('Глобальный обработчик: принудительно закрываем модальное окно');
                    forceCloseModal();
                }
            }

            // Комбинация клавиш Ctrl+Alt+R для принудительного восстановления взаимодействия
            if (event.ctrlKey && event.altKey && event.key === 'r') {
                event.preventDefault();
                console.log('Принудительное восстановление взаимодействия по комбинации клавиш');
                forceCloseModal();
                enableMainPageInteraction();
                alert('Взаимодействие с основной страницей восстановлено');
            }
        });

        // Добавляем обработчик для клика по backdrop
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('modal-backdrop')) {
                console.log('Клик по backdrop: принудительно закрываем модальное окно');
                forceCloseModal();
            }
        });

        // Проверяем состояние страницы каждые 5 секунд
        setInterval(function () {
            checkPageInteraction();
        }, 5000);
    });

    // Загрузка содержимого справочника
    async function loadDictionaryContent(dictionaryId) {
        // Проверяем, что передан корректный ID справочника
        if (!dictionaryId || dictionaryId === null || dictionaryId === undefined) {
            console.error('Не передан ID справочника');
            showContentError('Ошибка: не указан ID справочника');
            return;
        }

        // Преобразуем в число, если передана строка
        const numericId = parseInt(dictionaryId, 10);
        if (isNaN(numericId) || numericId <= 0) {
            console.error(`Некорректный ID справочника: ${dictionaryId}`);
            showContentError('Ошибка: некорректный ID справочника');
            return;
        }

        // Используем числовой ID для API запроса
        const apiDictionaryId = numericId;

        currentDictionaryId = dictionaryId;

        // Показываем индикатор загрузки
        const loadingIndicator = document.getElementById('contentLoadingIndicator');
        const errorMessage = document.getElementById('contentErrorMessage');
        const tableBody = document.getElementById('dictionaryContentTableBody');

        if (loadingIndicator) loadingIndicator.style.display = 'block';
        if (errorMessage) errorMessage.style.display = 'none';
        if (tableBody) tableBody.innerHTML = '';

        try {
            // Получаем токен доступа
            const accessToken = getAccessToken();

            if (!accessToken) {
                throw new Error('Токен доступа не найден. Пожалуйста, войдите в систему.');
            }

            console.log('Токен доступа получен успешно');

            // Получаем содержимое справочника через API
            // backend_api_url автоматически добавляется через Django context processor
            const apiUrl = `{{ backend_api_url }}/api/v2/models/dictionary/?dictionary=${apiDictionaryId}`;
            console.log(`Запрос к API: ${apiUrl}`);

            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Accept': 'application/json'
                }
            });

            console.log(`Ответ API: статус ${response.status}`);

            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Ошибка API: ${response.status} - ${errorText}`);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log(`Получены данные: ${data ? data.length : 'null'} позиций`);

            // Логируем структуру первой позиции для отладки
            if (data && data.length > 0) {
                console.log('Структура первой позиции:', data[0]);
                console.log('Поля позиции:', Object.keys(data[0]));
                if (data[0].attrs) {
                    console.log('Атрибуты первой позиции:', data[0].attrs);
                }
            }

            if (!data || !Array.isArray(data)) {
                console.warn('API вернул некорректные данные');
                currentDictionaryContent = [];
                displayDictionaryContent([]);
                return;
            }

            currentDictionaryContent = data;

            // Отображаем содержимое
            displayDictionaryContent(data);

            // Обновляем фильтры
            updateContentFilters(data);

        } catch (error) {
            console.error('Ошибка загрузки содержимого справочника:', error);

            // Сбрасываем состояние при ошибке
            currentDictionaryContent = [];

            // Показываем ошибку пользователю
            showContentError(`Ошибка загрузки содержимого: ${error.message}`);

            // Очищаем таблицу
            const tableBody = document.getElementById('dictionaryContentTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Ошибка загрузки данных</p>
                        <small>${error.message}</small>
                    </td>
                </tr>
            `;
            }
        } finally {
            const loadingIndicator = document.getElementById('contentLoadingIndicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }

    // Отображение содержимого справочника
    function displayDictionaryContent(content) {
        console.log('Отображение содержимого справочника в режиме:', currentViewMode);

        // Отображаем содержимое в зависимости от текущего режима
        if (currentViewMode === 'tree') {
            displayDictionaryTree(content);
        } else {
            displayDictionaryTable(content);
        }
    }

    // Отображение содержимого в виде таблицы
    function displayDictionaryTable(content) {
        const tbody = document.getElementById('dictionaryContentTableBody');
        if (!tbody) {
            console.error('Таблица для отображения содержимого не найдена');
            return;
        }

        tbody.innerHTML = '';

        if (!content || content.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>Справочник пуст</p>
                    <small>Данные не найдены или справочник не содержит позиций</small>
                </td>
            </tr>
        `;
            return;
        }

        content.forEach((position, index) => {
            try {
                // Проверяем корректность данных позиции
                if (!position || typeof position !== 'object') {
                    console.warn(`Некорректные данные позиции с индексом ${index}:`, position);
                    return;
                }

                // Получаем код и название из разных возможных источников
                let code = '';
                let name = '';

                // Проверяем прямые поля
                if (position.code) {
                    code = position.code;
                } else if (position.attrs && Array.isArray(position.attrs)) {
                    // Ищем в атрибутах
                    const codeAttr = position.attrs.find(attr => attr.name === 'Код');
                    if (codeAttr) code = codeAttr.value;
                }

                if (position.name) {
                    name = position.name;
                } else if (position.attrs && Array.isArray(position.attrs)) {
                    // Ищем в атрибутах
                    const nameAttr = position.attrs.find(attr => attr.name === 'Наименование');
                    if (nameAttr) name = nameAttr.value;
                }

                // Получаем parent_code из разных возможных источников
                let parentCode = '';
                if (position.parent_code) {
                    parentCode = position.parent_code;
                } else if (position.parent_id) {
                    // Используем parent_id для поиска по коду родителя
                    const parentPosition = currentDictionaryContent.find(p => p.id === position.parent_id);
                    if (parentPosition) {
                        parentCode = parentPosition.code || '';
                    }
                } else if (position.attrs && Array.isArray(position.attrs)) {
                    const parentAttr = position.attrs.find(attr => attr.name === 'Родитель');
                    if (parentAttr) parentCode = parentAttr.value;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                <td>
                    <span class="badge bg-primary">${code || '-'}</span>
                </td>
                <td>
                    <strong>${name || 'Без названия'}</strong>
                    ${position.description ? `<br><small class="text-muted">${position.description}</small>` : ''}
                </td>
                <td>
                    ${parentCode ? `<span class="badge bg-secondary">${parentCode}</span>` : '-'}
                </td>
                <td>
                    <small class="text-muted">${formatDate(position.start_date)}</small>
                </td>
                <td>
                    <small class="text-muted">${formatDate(position.end_date)}</small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewPosition(${index})" title="Просмотр">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="editPosition(${index})" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deletePosition(${index})" title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
                tbody.appendChild(row);
            } catch (error) {
                console.error(`Ошибка при отображении позиции ${index}:`, error);
            }
        });

        // Обновляем статистику
        updateContentStatistics(content);
    }

    // Обновление фильтров для содержимого
    function updateContentFilters(content) {
        // Фильтр по родителям
        const parentFilter = document.getElementById('contentParentFilter');
        if (!parentFilter) {
            console.warn('Фильтр по родителям не найден');
            return;
        }

        parentFilter.innerHTML = '<option value="">Все родители</option>';

        const parents = [...new Set(content
            .filter(item => {
                try {
                    return item && typeof item === 'object' && (
                        item.parent_code ||
                        item.parent_id ||
                        (item.attrs && Array.isArray(item.attrs) &&
                            item.attrs.find(attr => attr.name === 'Родитель'))
                    );
                } catch (error) {
                    console.warn('Ошибка при фильтрации родительских позиций:', error);
                    return false;
                }
            })
            .map(item => {
                try {
                    // Сначала проверяем прямое поле
                    if (item.parent_code) {
                        return item.parent_code;
                    }

                    // Затем проверяем parent_id
                    if (item.parent_id) {
                        const parentPosition = content.find(p => p.id === item.parent_id);
                        if (parentPosition) {
                            return parentPosition.code || '';
                        }
                    }

                    // Затем проверяем в атрибутах
                    if (item.attrs && Array.isArray(item.attrs)) {
                        const parentAttr = item.attrs.find(attr => attr.name === 'Родитель');
                        if (parentAttr) return parentAttr.value;
                    }

                    return null;
                } catch (error) {
                    console.warn('Ошибка при получении parent_code:', error);
                    return null;
                }
            })
            .filter(Boolean)
        )];

        parents.forEach(parent => {
            if (parent && parent !== '') {
                try {
                    const option = document.createElement('option');
                    option.value = parent;
                    option.textContent = parent;
                    parentFilter.appendChild(option);
                } catch (error) {
                    console.warn(`Ошибка при создании опции для родителя ${parent}:`, error);
                }
            }
        });

        // Устанавливаем текущую дату в фильтр дат
        const dateFilter = document.getElementById('contentDateFilter');
        if (dateFilter) {
            dateFilter.value = new Date().toISOString().split('T')[0];
        }
    }

    // Фильтрация содержимого справочника
    function filterDictionaryContent() {
        const searchInput = document.getElementById('contentSearchInput');
        const dateFilter = document.getElementById('contentDateFilter');
        const parentFilter = document.getElementById('contentParentFilter');

        if (!searchInput || !dateFilter || !parentFilter) {
            console.warn('Не все элементы фильтров найдены');
            return;
        }

        const searchTerm = searchInput.value.toLowerCase();
        const dateValue = dateFilter.value;
        const parentValue = parentFilter.value;

        console.log('Фильтрация содержимого:', {
            searchTerm,
            dateValue,
            parentValue,
            totalItems: currentDictionaryContent ? currentDictionaryContent.length : 0
        });

        if (!currentDictionaryContent || currentDictionaryContent.length === 0) {
            console.warn('Нет данных для фильтрации');
            return;
        }

        let debugCounter = 0;
        const filteredContent = currentDictionaryContent.filter(position => {
            try {
                // Проверяем корректность данных позиции
                if (!position || typeof position !== 'object') {
                    return false;
                }

                // Получаем код и название из разных возможных источников
                let code = '';
                let name = '';

                // Проверяем прямые поля
                if (position.code) {
                    code = position.code;
                } else if (position.attrs && Array.isArray(position.attrs)) {
                    // Ищем в атрибутах
                    const codeAttr = position.attrs.find(attr => attr.name === 'Код');
                    if (codeAttr) code = codeAttr.value;
                }

                if (position.name) {
                    name = position.name;
                } else if (position.attrs && Array.isArray(position.attrs)) {
                    // Ищем в атрибутах
                    const nameAttr = position.attrs.find(attr => attr.name === 'Наименование');
                    if (nameAttr) name = nameAttr.value;
                }

                // Поиск по коду и названию
                const matchesSearch = !searchTerm ||
                    (code && code.toLowerCase().includes(searchTerm)) ||
                    (name && name.toLowerCase().includes(searchTerm));

                // Фильтр по дате
                let matchesDate = true;
                if (dateValue) {
                    try {
                        const filterDate = new Date(dateValue);
                        const startDate = position.start_date ? new Date(position.start_date) : null;
                        const endDate = position.end_date ? new Date(position.end_date) : null;

                        // Проверяем, что позиция активна на выбранную дату
                        if (startDate && endDate) {
                            matchesDate = startDate <= filterDate && endDate >= filterDate;
                        } else if (startDate) {
                            matchesDate = startDate <= filterDate;
                        } else if (endDate) {
                            matchesDate = endDate >= filterDate;
                        } else {
                            matchesDate = false; // Нет дат - не показываем
                        }
                    } catch (error) {
                        console.warn('Ошибка при проверке даты:', error);
                        matchesDate = false;
                    }
                }

                // Получаем parent_code из разных возможных источников
                let parentCode = '';
                if (position.parent_code) {
                    parentCode = position.parent_code;
                } else if (position.parent_id) {
                    // Используем parent_id для поиска по коду родителя
                    const parentPosition = currentDictionaryContent.find(p => p.id === position.parent_id);
                    if (parentPosition) {
                        parentCode = parentPosition.code || '';
                    }
                } else if (position.attrs && Array.isArray(position.attrs)) {
                    const parentAttr = position.attrs.find(attr => attr.name === 'Родитель');
                    if (parentAttr) parentCode = parentAttr.value;
                }

                // Фильтр по родителю
                const matchesParent = !parentValue || parentCode === parentValue;

                // Логируем для отладки только первые несколько позиций
                if (searchTerm && debugCounter < 5) {
                    console.log('Проверка позиции:', {
                        id: position.id,
                        code,
                        name,
                        matchesSearch,
                        matchesDate,
                        matchesParent
                    });
                    debugCounter++;
                }

                return matchesSearch && matchesDate && matchesParent;
            } catch (error) {
                console.warn('Ошибка при фильтрации позиции:', error);
                return false;
            }
        });

        console.log(`Отфильтровано: ${filteredContent.length} из ${currentDictionaryContent.length} позиций`);

        // Показываем сообщение о результатах поиска
        if (searchTerm && filteredContent.length === 0) {
            showContentMessage(`Поиск по "${searchTerm}" не дал результатов`, 'warning');
        } else if (searchTerm && filteredContent.length > 0) {
            showContentMessage(`Найдено ${filteredContent.length} позиций по запросу "${searchTerm}"`, 'info');
        }

        // Отображаем отфильтрованный контент в зависимости от режима
        if (currentViewMode === 'tree') {
            displayDictionaryTree(filteredContent);
        } else {
            displayDictionaryTable(filteredContent);
        }
    }

    // Очистка фильтров содержимого
    function clearContentFilters() {
        const searchInput = document.getElementById('contentSearchInput');
        const dateFilter = document.getElementById('contentDateFilter');
        const parentFilter = document.getElementById('contentParentFilter');

        if (searchInput) searchInput.value = '';
        if (dateFilter) dateFilter.value = new Date().toISOString().split('T')[0];
        if (parentFilter) parentFilter.value = '';

        // Скрываем сообщения об ошибках
        const errorMessage = document.getElementById('contentErrorMessage');
        if (errorMessage) {
            errorMessage.style.display = 'none';
        }

        // Показываем все содержимое, если есть данные
        if (currentDictionaryContent && currentDictionaryContent.length > 0) {
            displayDictionaryContent(currentDictionaryContent);
        }
    }

    // Функция для оптимизации поиска (создание индекса)
    function createSearchIndex(content) {
        try {
            const searchIndex = new Map();

            content.forEach((position, positionIndex) => {
                if (!position || typeof position !== 'object') return;

                // Индексируем код
                if (position.code) {
                    const codeKey = position.code.toLowerCase();
                    if (!searchIndex.has(codeKey)) searchIndex.set(codeKey, []);
                    searchIndex.get(codeKey).push(position.id);
                }

                // Индексируем название
                if (position.name) {
                    const nameKey = position.name.toLowerCase();
                    if (!searchIndex.has(nameKey)) searchIndex.set(nameKey, []);
                    searchIndex.get(nameKey).push(position.id);
                }
            });

            console.log('Поисковый индекс создан:', searchIndex.size, 'ключей');
            return searchIndex;
        } catch (error) {
            console.error('Ошибка при создании поискового индекса:', error);
            return null;
        }
    }

    // Функция для отображения сообщений пользователю
    function showContentMessage(message, type = 'info') {
        try {
            const messageElement = document.getElementById('contentErrorMessage');
            if (!messageElement) return;

            // Очищаем предыдущие классы
            messageElement.className = 'alert';

            // Добавляем нужный класс
            switch (type) {
                case 'success':
                    messageElement.classList.add('alert-success');
                    break;
                case 'warning':
                    messageElement.classList.add('alert-warning');
                    break;
                case 'danger':
                    messageElement.classList.add('alert-danger');
                    break;
                default:
                    messageElement.classList.add('alert-info');
            }

            // Устанавливаем сообщение
            const errorText = messageElement.querySelector('#contentErrorText');
            if (errorText) {
                errorText.textContent = message;
            }

            // Показываем сообщение
            messageElement.style.display = 'block';

            // Автоматически скрываем через 5 секунд
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);

        } catch (error) {
            console.error('Ошибка при отображении сообщения:', error);
        }
    }

    // Функция для тестирования поиска (отладка)
    function testSearch() {
        console.log('=== ТЕСТИРОВАНИЕ ПОИСКА ===');

        if (!currentDictionaryContent || currentDictionaryContent.length === 0) {
            console.log('Нет данных для тестирования');
            return;
        }

        console.log('Всего позиций:', currentDictionaryContent.length);

        // Проверяем первую позицию
        const firstPosition = currentDictionaryContent[0];
        console.log('Первая позиция:', firstPosition);

        // Проверяем поля
        console.log('Прямые поля:');
        console.log('- code:', firstPosition.code);
        console.log('- name:', firstPosition.name);
        console.log('- parent_code:', firstPosition.parent_code);

        // Проверяем атрибуты
        if (firstPosition.attrs && Array.isArray(firstPosition.attrs)) {
            console.log('Атрибуты:');
            firstPosition.attrs.forEach((attr, index) => {
                console.log(`  ${index}: ${attr.name} = ${attr.value}`);
            });
        }

        // Тестируем поиск
        const searchInput = document.getElementById('contentSearchInput');
        if (searchInput) {
            console.log('Текущий поисковый запрос:', searchInput.value);
            console.log('Вызываем фильтрацию...');
            filterDictionaryContent();
        }

        console.log('=== КОНЕЦ ТЕСТИРОВАНИЯ ===');
    }

    // Обновление содержимого справочника
    function refreshDictionaryContent() {
        if (currentDictionaryId && currentDictionaryId !== null && currentDictionaryId !== undefined) {
            console.log(`Обновление содержимого справочника с ID: ${currentDictionaryId}`);
            loadDictionaryContent(currentDictionaryId);
        } else {
            console.warn('Не выбран справочник для обновления');
            // Показываем сообщение пользователю
            showContentError('Сначала выберите справочник для просмотра');
        }
    }

    // Экспорт содержимого справочника
    function exportDictionaryContent() {
        if (!currentDictionaryId || currentDictionaryId === null || currentDictionaryId === undefined) {
            alert('Не выбран справочник для экспорта');
            return;
        }

        if (!currentDictionaryContent || currentDictionaryContent.length === 0) {
            alert('Нет данных для экспорта');
            return;
        }

        const csvContent = 'Код,Название,Описание,Родитель,Дата начала,Дата окончания\n';
        const csvData = currentDictionaryContent
            .filter(position => {
                try {
                    return position && typeof position === 'object';
                } catch (error) {
                    console.warn('Ошибка при фильтрации позиций для экспорта:', error);
                    return false;
                }
            })
            .map((position, index) => {
                try {
                    return `"${position.code || ''}","${position.name || ''}","${position.description || ''}","${position.parent_code || ''}","${position.start_date || ''}","${position.end_date || ''}"`;
                } catch (error) {
                    console.warn(`Ошибка при обработке позиции ${index} для экспорта:`, error);
                    return '';
                }
            })
            .filter(row => row !== '')
            .join('\n');

        try {
            const blob = new Blob([csvContent + csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `содержимое_справочника_${currentDictionaryId || 'unknown'}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Очищаем URL объект
            URL.revokeObjectURL(url);

            console.log('Содержимое справочника успешно экспортировано в CSV');
        } catch (error) {
            console.error('Ошибка при экспорте содержимого справочника:', error);
            alert('Ошибка при экспорте файла');
        }
    }

    // Обновление статистики содержимого
    function updateContentStatistics(content) {
        if (!content || !Array.isArray(content)) {
            console.warn('Некорректные данные для статистики');
            return;
        }

        const totalCount = content.length;
        const activeCount = content.filter(item => {
            if (!item || typeof item !== 'object') return false;

            try {
                return item.start_date && item.end_date &&
                    new Date() >= new Date(item.start_date) &&
                    new Date() <= new Date(item.end_date);
            } catch (error) {
                console.warn(`Ошибка при проверке дат позиции:`, error);
                return false;
            }
        }).length;

        // Дополнительная проверка корректности подсчета
        if (totalCount < 0 || activeCount < 0) {
            console.warn(`Некорректные значения счетчиков:`, { totalCount, activeCount });
        }

        // Можно добавить отображение статистики в модальном окне
        console.log(`Всего позиций: ${totalCount}, Активных: ${activeCount}`);

        // Возвращаем статистику для возможного использования
        try {
            return {
                total: totalCount,
                active: activeCount
            };
        } catch (error) {
            console.error('Ошибка при возврате статистики:', error);
            return {
                total: 0,
                active: 0
            };
        }
    }

    // Показать ошибку содержимого
    function showContentError(message) {
        const errorText = document.getElementById('contentErrorText');
        const errorMessage = document.getElementById('contentErrorMessage');

        if (errorText) errorText.textContent = message;
        if (errorMessage) errorMessage.style.display = 'block';
    }

    // Функции для работы с позициями (заглушки)
    function viewPosition(index) {
        if (!currentDictionaryContent || !Array.isArray(currentDictionaryContent)) {
            console.error('Нет данных о позициях справочника');
            alert('Ошибка: нет данных о позициях');
            return;
        }

        const position = currentDictionaryContent[index];
        if (!position) {
            console.error(`Позиция с индексом ${index} не найдена`);
            alert('Ошибка: позиция не найдена');
            return;
        }

        alert(`Просмотр позиции: ${position.name || position.code}`);
    }

    function editPosition(index) {
        if (!currentDictionaryContent || !Array.isArray(currentDictionaryContent)) {
            console.error('Нет данных о позициях справочника');
            alert('Ошибка: нет данных о позициях');
            return;
        }

        const position = currentDictionaryContent[index];
        if (!position) {
            console.error(`Позиция с индексом ${index} не найдена`);
            alert('Ошибка: позиция не найдена');
            return;
        }

        alert(`Редактирование позиции: ${position.name || position.code}`);
    }

    function deletePosition(index) {
        if (!currentDictionaryContent || !Array.isArray(currentDictionaryContent)) {
            console.error('Нет данных о позициях справочника');
            alert('Ошибка: нет данных о позициях');
            return;
        }

        const position = currentDictionaryContent[index];
        if (!position) {
            console.error(`Позиция с индексом ${index} не найдена`);
            alert('Ошибка: позиция не найдена');
            return;
        }

        if (confirm(`Удалить позицию "${position.name || position.code}"?`)) {
            // Здесь будет логика удаления
            alert('Функция удаления пока не реализована');
        }
    }

    // Получение токена доступа
    function getAccessToken() {
        // Получаем токен из Django сессии через контекст
        const token = '{{ access_token }}';

        if (!token || token === 'None' || token === '') {
            console.error('Токен доступа не найден в контексте');
            return null;
        }

        return token;
    }

    // Добавляем обработчики событий после загрузки DOM
    document.addEventListener('DOMContentLoaded', function () {
        // Обработчики для фильтров содержимого справочника
        const contentSearchInput = document.getElementById('contentSearchInput');
        const contentDateFilter = document.getElementById('contentDateFilter');
        const contentParentFilter = document.getElementById('contentParentFilter');

        if (contentSearchInput) {
            contentSearchInput.addEventListener('input', filterDictionaryContent);
        }

        if (contentDateFilter) {
            contentDateFilter.addEventListener('change', filterDictionaryContent);
        }

        if (contentParentFilter) {
            contentParentFilter.addEventListener('change', filterDictionaryContent);
        }

        // Обработчики для кнопок действий в таблице справочников
        document.addEventListener('click', function (e) {
            // Обработчик для кликабельных элементов (код и название справочника)
            if (e.target.closest('.clickable-code, .clickable-name')) {
                const element = e.target.closest('.clickable-code, .clickable-name');
                const dictId = element.getAttribute('data-dict-id');
                const dictName = element.getAttribute('data-dict-name');
                viewDictionaryContent(dictId, dictName);
            }

            // Обработчик для редактирования описания
            if (e.target.closest('.edit-description-btn')) {
                const button = e.target.closest('.edit-description-btn');
                const dictId = button.getAttribute('data-dict-id');
                const dictName = button.getAttribute('data-dict-name');
                editDictionaryDescription(dictId, dictName);
            }

            if (e.target.closest('.edit-dict-btn')) {
                const button = e.target.closest('.edit-dict-btn');
                const dictId = button.getAttribute('data-dict-id');
                editDictionary(dictId);
            }

            if (e.target.closest('.delete-dict-btn')) {
                const button = e.target.closest('.delete-dict-btn');
                const dictId = button.getAttribute('data-dict-id');
                const dictName = button.getAttribute('data-dict-name');
                deleteDictionary(dictId, dictName);
            }

            if (e.target.closest('.view-dict-btn')) {
                const button = e.target.closest('.view-dict-btn');
                const dictId = button.getAttribute('data-dict-id');
                const dictName = button.getAttribute('data-dict-name');
                viewDictionary(dictId, dictName);
            }
        });
    });
</script>

<style>
    .welcome-section {
        background: var(--gradient-primary);
        color: var(--white);
        padding: 3rem 0;
        margin-bottom: 3rem;
        position: relative;
        overflow: hidden;
        border-radius: 1rem;
        margin-bottom: 3rem;
    }

    .welcome-content {
        text-align: center;
    }

    .welcome-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .welcome-subtitle {
        font-size: 1.125rem;
        opacity: 0.9;
        margin-bottom: 2rem;
    }

    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.75rem;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        border-radius: 0.75rem 0.75rem 0 0 !important;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
    }

    .btn-group .btn {
        margin-right: 0.25rem;
    }

    .btn-group .btn:last-child {
        margin-right: 0;
    }

    /* Стили для кнопки редактирования описания */
    .edit-description-btn {
        transition: all 0.3s ease;
    }

    .edit-description-btn:hover {
        background-color: #17a2b8 !important;
        border-color: #17a2b8 !important;
        color: white !important;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
    }

    .badge {
        font-size: 0.75em;
    }

    .table-responsive {
        border-radius: 0.5rem;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
    }

    .sortable:hover {
        background-color: #e9ecef;
    }

    .sortable i {
        margin-left: 0.5rem;
        opacity: 0.5;
    }

    .sortable.sort-asc i::before {
        content: "\f0de";
        /* fa-sort-up */
        opacity: 1;
    }

    .sortable.sort-desc i::before {
        content: "\f0dd";
        /* fa-sort-down */
        opacity: 1;
    }

    /* Стили для модального окна содержимого справочника */
    .modal-xl {
        max-width: 95%;
    }

    #dictionaryContentTable {
        font-size: 0.875rem;
    }

    #dictionaryContentTable th {
        font-size: 0.8rem;
        font-weight: 600;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    #dictionaryContentTable td {
        vertical-align: middle;
        padding: 0.5rem;
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    #contentLoadingIndicator {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }

    #contentErrorMessage {
        border-radius: 0.5rem;
    }

    .badge {
        font-size: 0.75em;
        padding: 0.35em 0.65em;
    }

    /* Анимации для загрузки */
    .spinner-border {
        animation: spinner-border 0.75s linear infinite;
    }

    @keyframes spinner-border {
        to {
            transform: rotate(360deg);
        }
    }

    /* Стили для модального окна загрузки */
    .loading {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 8px;
    }

    .loading .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.25rem;
    }

    .loading p {
        color: #6c757d;
        font-size: 1.1rem;
        margin-top: 1rem;
    }

    /* Стили для модального окна */
    #modalContainer .modal-dialog {
        max-width: 800px;
    }

    #modalContainer .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    #modalContainer .modal-header {
        border-bottom: 2px solid #e9ecef;
        border-radius: 12px 12px 0 0;
    }

    #modalContainer .modal-body {
        padding: 1.5rem;
    }

    #modalContainer .modal-footer {
        border-top: 2px solid #e9ecef;
        border-radius: 0 0 12px 12px;
    }

    /* Стили для кликабельных элементов */
    .clickable-code {
        transition: all 0.3s ease;
        user-select: none;
        position: relative;
        overflow: hidden;
    }

    .clickable-code:hover {
        background-color: #6c757d !important;
        color: white !important;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .clickable-code::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .clickable-code:hover::before {
        left: 100%;
    }

    .clickable-name {
        transition: all 0.3s ease;
        user-select: none;
        position: relative;
    }

    .clickable-name:hover {
        color: #0056b3 !important;
        text-decoration: underline;
        transform: scale(1.02);
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .clickable-name::after {
        content: ' 👁';
        opacity: 0;
        transition: opacity 0.3s ease;
        font-size: 0.8em;
    }

    .clickable-name:hover::after {
        opacity: 1;
    }
</style>
{% endblock %}