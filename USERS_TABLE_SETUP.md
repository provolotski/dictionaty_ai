# Настройка таблицы users

## Описание

Этот документ содержит инструкции по настройке таблицы `users` для расширенной функциональности управления пользователями, включая поля для подразделений и членства в группах.

## Структура таблицы

Таблица `users` должна содержать следующие поля:

| Поле | Тип | Описание | По умолчанию |
|------|-----|----------|--------------|
| `id` | SERIAL | Уникальный идентификатор | Автоинкремент |
| `guid` | VARCHAR(255) | GUID пользователя из AD | Обязательно |
| `name` | VARCHAR(255) | Имя пользователя | Обязательно |
| `is_active` | BOOLEAN | Флаг активности | TRUE |
| `is_admin` | BOOLEAN | Флаг администратора системы | FALSE |
| `department` | VARCHAR(255) | Подразделение пользователя | NULL |
| `is_user` | BOOLEAN | Флаг вхождения в группу EISGS_Users | FALSE |
| `created_at` | TIMESTAMP | Дата создания | CURRENT_TIMESTAMP |
| `updated_at` | TIMESTAMP | Дата обновления | CURRENT_TIMESTAMP |

## Варианты настройки

### Вариант 1: Создание новой таблицы (рекомендуется для разработки)

Если вы можете пересоздать таблицу:

```bash
cd backend/database/public
psql -U admin_eisgs -d your_database -f users.sql
```

### Вариант 2: Изменение существующей таблицы (для продакшена)

Если нужно сохранить существующие данные:

```bash
cd backend/database/public
psql -U admin_eisgs -d your_database -f alter_users_table.sql
```

## Проверка структуры

После применения изменений проверьте структуру таблицы:

```sql
\d users;
```

Убедитесь, что все необходимые поля присутствуют.

## Индексы

Скрипт автоматически создает следующие индексы для оптимизации:

- `idx_users_guid` - для быстрого поиска по GUID
- `idx_users_name` - для поиска по имени
- `idx_users_department` - для фильтрации по подразделению
- `idx_users_is_user` - для фильтрации по флагу is_user
- `idx_users_is_admin` - для фильтрации по флагу is_admin
- `idx_users_is_active` - для фильтрации по флагу is_active

## Триггеры

Автоматически создается триггер `update_users_updated_at`, который обновляет поле `updated_at` при каждом изменении записи.

## Тестовые данные

Скрипт создания таблицы включает тестовые данные:

- Тестовый Администратор (IT отдел)
- Тестовый Пользователь (HR отдел)  
- Тестовый Владелец (Finance отдел)

## Возможные проблемы

### Ошибка "column does not exist"

Если получаете ошибки о несуществующих колонках:

1. Убедитесь, что скрипт `alter_users_table.sql` выполнен успешно
2. Проверьте, что все поля добавлены: `\d users`
3. Перезапустите backend сервер

### Ошибка "permission denied"

Если получаете ошибки прав доступа:

1. Убедитесь, что пользователь `admin_eisgs` имеет права на изменение таблицы
2. Проверьте права доступа: `\l+` и `\du`

### Ошибка "table does not exist"

Если таблица не существует:

1. Сначала выполните `users.sql` для создания таблицы
2. Затем выполните `alter_users_table.sql` для добавления полей

## Следующие шаги

После успешной настройки таблицы:

1. Перезапустите backend сервер
2. Проверьте API endpoints: `GET /api/v1/users/`
3. Протестируйте функциональность управления пользователями
4. Настройте синхронизацию с Active Directory

## Проверка работоспособности

Для проверки работоспособности API:

```bash
# Проверка health endpoint
curl http://localhost:8000/health

# Проверка списка пользователей
curl http://localhost:8000/api/v1/users/

# Проверка конкретного пользователя
curl http://localhost:8000/api/v1/users/1
```

## Логирование

Все операции с таблицей логируются в:

- `backend/logs/dictionaryAPI.log` - основные операции API
- `backend/logs/backend.log` - системные события

## Поддержка

При возникновении проблем:

1. Проверьте логи backend сервера
2. Убедитесь в корректности структуры таблицы
3. Проверьте права доступа к базе данных
4. Обратитесь к документации по API
