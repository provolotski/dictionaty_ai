# Настройка функциональности "Владелец справочника"

## Описание

Добавлена возможность назначать пользователей владельцами справочников. Пользователи с ролью "Хозяин справочника" могут редактировать и импортировать данные в назначенные им справочники.

## Архитектура

### Backend (FastAPI)

1. **Новая таблица**: `dictionary_owner` - связывает пользователей со справочниками
2. **Новые схемы**: `DictionaryOwnerIn`, `DictionaryOwnerOut`, `DictionaryOwnerWithInfo`
3. **Новый сервис**: `DictionaryOwnerService` - управление владельцами справочников
4. **Новые API endpoints**:
   - `GET /api/v1/users/{user_id}/with-ownership` - получение пользователя с информацией о владении
   - `POST /api/v1/users/{user_id}/dictionary-ownership` - добавление права владения
   - `DELETE /api/v1/users/{user_id}/dictionary-ownership/{dictionary_id}` - удаление права владения
   - `GET /api/v1/users/dictionaries/available` - список доступных справочников

### Frontend (Django)

1. **Новые views**: функции для работы с владельцами справочников
2. **Новые URL-маршруты**: endpoints для управления владением
3. **Обновленный шаблон**: расширенная карточка пользователя с управлением справочниками
4. **JavaScript функциональность**: добавление/удаление прав владения

## Предварительные требования

### Настройка таблицы users

Перед использованием функциональности "Владелец справочника" необходимо настроить таблицу `users` в базе данных. Таблица должна содержать все необходимые поля для расширенной функциональности.

**Важно**: Если таблица `users` не содержит необходимые поля, API будет возвращать ошибки типа "column does not exist".

#### Вариант 1: Создание новой таблицы (рекомендуется для разработки)

```bash
cd backend/database/public
psql -U admin_eisgs -d your_database -f users.sql
```

#### Вариант 2: Изменение существующей таблицы (для продакшена)

```bash
cd backend/database/public
psql -U admin_eisgs -d your_database -f alter_users_table.sql
```

Подробные инструкции по настройке таблицы см. в файле `USERS_TABLE_SETUP.md`.

## Установка

### 1. Создание таблицы в базе данных

Выполните SQL скрипт для создания таблицы `dictionary_owner`:

```bash
psql -U your_user -d your_database -f backend/database/public/dictionary_owner.sql
```

### 2. Обновление backend

1. Скопируйте новые файлы:
   - `backend/models/model_dictionary_owner.py`
   - Обновите `backend/schemas.py`
   - Обновите `backend/routers/users.py`

2. Перезапустите backend сервер

### 3. Обновление frontend

1. Обновите существующие файлы:
   - `frontend/accounts/views.py`
   - `frontend/accounts/urls.py`
   - `frontend/accounts/utils.py`
   - `frontend/templates/users.html`

2. Перезапустите frontend сервер

## Использование

### Для администраторов безопасности (EISGS_AppSecurity)

1. Откройте страницу "Пользователи системы"
2. Нажмите на строку пользователя для открытия карточки
3. Для пользователей, не являющихся администраторами системы, будет показана секция "Управление справочниками"
4. Используйте селект для добавления новых справочников
5. Используйте кнопки "Убрать" для удаления прав владения

### Логика работы

- **Администраторы системы** (`is_admin = true`) автоматически являются владельцами всех справочников
- **Обычные пользователи** могут быть назначены владельцами конкретных справочников
- **Администраторы безопасности** могут управлять назначением владельцев
- При назначении пользователя администратором системы, все права владения справочниками автоматически удаляются

## API Endpoints

### Получение пользователя с владением справочниками
```http
GET /api/v1/users/{user_id}/with-ownership
```

### Добавление права владения
```http
POST /api/v1/users/{user_id}/dictionary-ownership
Content-Type: application/json

{
  "id_dictionary": 123
}
```

### Удаление права владения
```http
DELETE /api/v1/users/{user_id}/dictionary-ownership/{dictionary_id}
```

### Получение доступных справочников
```http
GET /api/v1/users/dictionaries/available
```

## Структура данных

### Таблица dictionary_owner
```sql
CREATE TABLE dictionary_owner (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    id_dictionary INTEGER REFERENCES dictionary(id),
    id_user INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Уникальный индекс
```sql
CREATE UNIQUE INDEX dictionary_owner_dictionary_user_uindex 
ON dictionary_owner (id_dictionary, id_user);
```

## Безопасность

- Доступ к управлению владельцами справочников имеют только пользователи в группе `EISGS_AppSecurity`
- Проверяется существование справочника и пользователя перед созданием связи
- Предотвращается дублирование записей через уникальный индекс
- Администраторы системы не могут быть назначены владельцами конкретных справочников

## Логирование

Все операции с владельцами справочников логируются:
- Создание права владения
- Удаление права владения
- Ошибки при операциях
- Попытки несанкционированного доступа

## Тестирование

Для тестирования функциональности:

1. Создайте пользователя в группе `EISGS_AppSecurity`
2. Создайте обычного пользователя (не администратора)
3. Создайте несколько справочников
4. Проверьте назначение и удаление прав владения
5. Проверьте отображение в карточке пользователя

## Возможные проблемы

1. **Ошибка 403 Forbidden**: проверьте, что пользователь входит в группу `EISGS_AppSecurity`
2. **Ошибка 404**: проверьте существование пользователя и справочника
3. **Ошибка 400**: проверьте, что пользователь не является администратором системы
4. **Дублирование записей**: проверьте уникальность индекса в базе данных

## Устранение неполадок

### Ошибка "Ошибка загрузки доступных справочников"

**Причина**: Неправильный URL для API endpoints или недоступность backend сервера.

**Решение**:
1. Проверьте, что backend сервер запущен на порту 8000
2. Убедитесь, что в Django settings правильно настроен `BACKEND_API_URL`
3. Проверьте логи backend сервера на наличие ошибок
4. Запустите тестовый скрипт: `python test_api_endpoints.py`

### Ошибка "Пользователь не найден"

**Причина**: Пользователь с указанным ID не существует в базе данных.

**Решение**:
1. Проверьте, что таблица `users` содержит данные
2. Убедитесь, что ID пользователя корректный
3. Проверьте права доступа пользователя к API

### Проверка работоспособности

1. **Запустите тестовый скрипт**:
   ```bash
   python test_api_endpoints.py
   ```

2. **Проверьте логи backend сервера**:
   ```bash
   tail -f logs/dictionaryAPI.log
   ```

3. **Проверьте логи frontend**:
   ```bash
   tail -f frontend/logs/django.log
   ```

4. **Проверьте доступность API в браузере**:
   - `http://localhost:8000/api/v1/users/`
   - `http://localhost:8000/api/v1/users/dictionaries/available`

### Отладка в браузере

1. Откройте Developer Tools (F12)
2. Перейдите на вкладку Console
3. Откройте карточку пользователя
4. Проверьте логи и ошибки

### Проверка настроек

1. **Django settings** - проверьте `BACKEND_API_URL`
2. **Backend конфигурация** - проверьте порт и настройки CORS
3. **База данных** - проверьте существование таблиц и данных
4. **Сетевые настройки** - проверьте доступность портов

## Дальнейшее развитие

Возможные улучшения:
1. Массовое назначение владельцев
2. Временные права владения
3. Делегирование прав
4. Уведомления об изменениях
5. Аудит операций с владельцами

## Расширение таблицы users

### Новые поля

В таблицу `users` добавлены новые поля для расширенной функциональности:

1. **`department`** (VARCHAR(255)) - Подразделение пользователя
   - Заполняется из атрибута "OU" из API аутентификации
   - Автоматически обновляется при синхронизации с Active Directory
   - Позволяет группировать пользователей по подразделениям

2. **`is_user`** (BOOLEAN) - Флаг вхождения в группу "EISGS_Users"
   - Автоматически устанавливается на основе членства в группе
   - Используется для определения базовых прав доступа к системе
   - Обновляется при каждой синхронизации с AD

### Установка новых полей

1. **Выполните SQL скрипт**:
   ```bash
   psql -U admin_eisgs -d your_database -f backend/database/public/alter_users_table.sql
   ```

2. **Проверьте структуру таблицы**:
   ```sql
   \d users;
   ```

### Синхронизация данных

Для автоматического обновления полей `department` и `is_user` используется скрипт синхронизации:

1. **Установите переменные окружения**:
   ```bash
   export AUTH_API_URL="http://127.0.0.1:9090"
   export BACKEND_API_URL="http://127.0.0.1:8000"
   export ACCESS_TOKEN="your_access_token_here"
   ```

2. **Запустите скрипт синхронизации**:
   ```bash
   python update_users_from_auth.py
   ```

3. **Настройте автоматический запуск** (cron):
   ```bash
   # Обновление каждый час
   0 * * * * cd /path/to/project && python update_users_from_auth.py >> update_users.log 2>&1
   ```

### API endpoints

Новые поля доступны через обновленные API endpoints:

- `GET /api/v1/users/` - список пользователей с фильтрацией по подразделению и флагу is_user
- `GET /api/v1/users/{id}` - информация о пользователе
- `PUT /api/v1/users/{id}` - обновление пользователя
- `POST /api/v1/users/` - создание пользователя

### Фильтрация и поиск

В API добавлены новые параметры фильтрации:

- `department` - фильтр по подразделению
- `is_user` - фильтр по флагу вхождения в группу EISGS_Users
- `search` - поиск по имени пользователя или подразделению

Пример запроса:
```
GET /api/v1/users/?department=IT&is_user=true&search=админ
```

## Возможные проблемы
