# Система прав доступа для справочников

## Обзор

Реализована система прав доступа, которая определяет, может ли пользователь редактировать справочник или только просматривать его. Система основана на ролях пользователя и правах владения справочниками.

## Принцип работы

### Уровни доступа

1. **Администратор системы** (`is_admin = True`)
   - Может редактировать любой справочник
   - Полный доступ ко всем функциям

2. **Владелец справочника** (`dictionary_owner`)
   - Может редактировать только свои справочники
   - Доступ определяется через таблицу `dictionary_owner`

3. **Обычный пользователь**
   - Может только просматривать справочники
   - Не может редактировать

### Логика проверки прав

```python
def can_edit_dictionary(request, dictionary_id):
    # 1. Проверяем, является ли пользователь администратором
    if is_admin:
        return can_edit = True
    
    # 2. Проверяем, является ли пользователь владельцем справочника
    if is_dictionary_owner:
        return can_edit = True
    
    # 3. Если ни то, ни другое - только просмотр
    return can_edit = False
```

## Как это работает

### 1. Пользователь заходит на страницу описания
- Система проверяет его права через `can_edit_dictionary()`
- Определяется роль: администратор, владелец или обычный пользователь

### 2. Отображение кнопки
- **Администратор/Владелец**: Видит желтую кнопку "Редактировать справочник"
- **Обычный пользователь**: Видит синюю кнопку "Просмотреть справочник"

### 3. При нажатии на кнопку
- **Редактирование**: Переход на страницу редактирования с предзаполненными полями
- **Просмотр**: Переход на страницу просмотра с недоступными полями

### 4. Защита на уровне представлений
- Представление редактирования проверяет права перед доступом
- При отсутствии прав - редирект с сообщением об ошибке

### 5. Интеграция со списком справочников
- При загрузке списка проверяются права для каждого справочника
- Кнопки действий отображаются условно в зависимости от прав
- Создание справочников доступно только администраторам

## Что реализовано

### 1. Модуль проверки прав
- **Файл**: `frontend/Dictionary/permissions.py`
- **Основная функция**: `can_edit_dictionary(request, dictionary_id)`
- **Возвращает**: Словарь с информацией о правах пользователя

### 2. Обновленное представление описания
- **Файл**: `frontend/Dictionary/views.py` - `dictionary_description_view`
- **Функциональность**: Передает информацию о правах в шаблон
- **Результат**: Кнопка меняется в зависимости от прав

### 3. Защищенное представление редактирования
- **Файл**: `frontend/Dictionary/views.py` - `dictionary_edit`
- **Функциональность**: Проверяет права перед доступом к редактированию
- **Безопасность**: Редирект при отсутствии прав

### 4. Новое представление просмотра
- **Файл**: `frontend/Dictionary/views.py` - `dictionary_view_view`
- **Функциональность**: Показывает форму с недоступными полями
- **Назначение**: Для пользователей без прав на редактирование

### 5. Обновленный шаблон описания
- **Файл**: `frontend/templates/dictionaryDescription.html`
- **Логика**: Условное отображение кнопки редактирования/просмотра
- **Стили**: Разные цвета для разных типов кнопок

### 6. Новый шаблон просмотра
- **Файл**: `frontend/templates/dictionaries/view_form_full.html`
- **Особенности**: Все поля недоступны для редактирования
- **Дизайн**: Синяя цветовая схема для отличия от редактирования

### 7. Обновленная страница списка справочников
- **Файл**: `frontend/templates/dictionaryList.html`
- **Функциональность**: Условное отображение кнопок действий
- **Права**: Кнопки редактирования/удаления только для авторизованных
- **Создание**: Кнопка создания только для администраторов

### 8. Custom template filter
- **Файл**: `frontend/Dictionary/templatetags/dictionary_filters.py`
- **Функция**: `get_item` для работы с вложенными словарями
- **Использование**: `{{ user_permissions|get_item:dict.id|get_item:'can_edit' }}`

## Техническая реализация

### Проверка прав администратора

```python
def check_if_admin(guid, username):
    if guid:
        user_data = fetch_user_by_guid_from_backend(guid)
        if user_data and user_data.get('is_admin'):
            return True
    return False
```

### Проверка прав владельца

```python
def check_if_dictionary_owner(guid, username, dictionary_id):
    if guid:
        user_data = fetch_user_by_guid_from_backend(guid)
        if user_data:
            user_id = user_data.get('id')
            if user_id:
                ownership_data = fetch_user_with_ownership_from_backend(user_id)
                # Проверяем, есть ли справочник в списке владения
                return dictionary_id in owned_dictionaries
    return False
```

### API интеграция

- **Backend API**: `/api/v1/users/guid/{guid}` - получение данных пользователя
- **Backend API**: `/api/v1/users/{user_id}/with-ownership` - получение владения справочниками
- **Таймаут**: 15 секунд для API запросов
- **Обработка ошибок**: Логирование и fallback значения

## Интерфейс пользователя

### Кнопки на странице описания

#### Для пользователей с правами редактирования:
```html
<a href="{% url 'dictionary_edit' dictionary.id %}" class="btn-custom btn-warning-custom">
    <i class="fas fa-edit"></i>
    Редактировать справочник
</a>
```

#### Для пользователей без прав редактирования:
```html
<a href="{% url 'dictionary_view' dictionary.id %}" class="btn-custom btn-info-custom">
    <i class="fas fa-eye"></i>
    Просмотреть справочник
</a>
```

### Стили кнопок

- **Редактирование**: Желтая кнопка (`btn-warning-custom`)
- **Просмотр**: Синяя кнопка (`btn-info-custom`)
- **Hover эффекты**: Анимация и тени

### Страница просмотра

- **Заголовок**: "Просмотр справочника"
- **Индикатор**: "Режим просмотра - поля недоступны для редактирования"
- **Поля**: Все поля имеют атрибуты `readonly` и `disabled`
- **Визуальная индикация**: Серый фон, курсор `not-allowed`

### Список справочников

#### Кнопки действий для каждого справочника
- **Редактирование**: Желтая кнопка с иконкой карандаша (только для администраторов и владельцев)
- **Просмотр**: Синяя кнопка с иконкой глаза (для обычных пользователей)
- **Удаление**: Красная кнопка с иконкой корзины (только для администраторов и владельцев)
- **Создание**: Синяя кнопка "Создать справочник" (только для администраторов)

## Безопасность

### Защита на уровне представлений

1. **Проверка авторизации**: `@require_users_group` декоратор
2. **Проверка прав**: Функция `can_edit_dictionary()`
3. **Редирект при нарушении**: Возврат на страницу описания с сообщением об ошибке

### Защита на уровне шаблонов

1. **Условное отображение**: Кнопки показываются в зависимости от прав
2. **Безопасные ссылки**: URL генерируются через Django теги
3. **Валидация данных**: Проверка существования справочника

### Логирование

- **Успешные проверки**: Информационные сообщения
- **Ошибки доступа**: Предупреждения
- **API ошибки**: Детальное логирование

## Обработка ошибок

### Типы ошибок

1. **Пользователь не авторизован**
   - Редирект на страницу входа
   - Сообщение: "Пользователь не авторизован"

2. **Недостаточно информации о пользователе**
   - Отказ в доступе
   - Сообщение: "Недостаточно информации о пользователе"

3. **Ошибка API**
   - Fallback на безопасные значения
   - Логирование ошибки

4. **Отсутствие прав**
   - Редирект на страницу описания
   - Сообщение: "У вас нет прав на редактирование этого справочника"

### Fallback стратегии

- **При ошибке API**: Возврат `False` для прав доступа
- **При отсутствии GUID**: Попытка проверки по username
- **При ошибке сети**: Таймаут и повторные попытки

## Производительность

### Оптимизации

1. **Кэширование сессии**: Данные пользователя хранятся в сессии
2. **Ленивая загрузка**: API запросы только при необходимости
3. **Таймауты**: Ограничение времени ожидания API ответов

### Мониторинг

- **Время ответа API**: Логирование для отслеживания производительности
- **Количество запросов**: Статистика использования
- **Ошибки**: Алерты при критических проблемах

## Возможные улучшения

### Функциональность

1. **Кэширование прав**: Redis для хранения прав доступа
2. **Групповые права**: Роли и разрешения для групп пользователей
3. **Временные права**: Ограничение по времени действия прав
4. **Аудит доступа**: Логирование всех попыток доступа

### UX/UI

1. **Индикатор прав**: Визуальное отображение текущих прав
2. **Запрос прав**: Форма для запроса дополнительных прав
3. **Уведомления**: Оповещения об изменении прав
4. **История изменений**: Отслеживание изменений в правах

### Безопасность

1. **Двухфакторная аутентификация**: Для критических операций
2. **IP ограничения**: Доступ только с определенных адресов
3. **Сессионные токены**: JWT токены для API запросов
4. **Шифрование**: Защита чувствительных данных

## Тестирование

### Unit тесты

1. **Проверка прав администратора**: Тест функции `check_if_admin`
2. **Проверка прав владельца**: Тест функции `check_if_dictionary_owner`
3. **Проверка общей функции**: Тест `can_edit_dictionary`

### Интеграционные тесты

1. **API интеграция**: Тест взаимодействия с backend
2. **Представления**: Тест работы с правами доступа
3. **Шаблоны**: Тест условного отображения

### Тестовые сценарии

1. **Администратор**: Полный доступ ко всем справочникам
2. **Владелец**: Доступ только к своим справочникам
3. **Обычный пользователь**: Только просмотр
4. **Неавторизованный**: Редирект на вход

## Развертывание

### Требования

1. **Django**: Версия 3.2+
2. **Python**: Версия 3.8+
3. **Backend API**: Доступность endpoints для пользователей
4. **База данных**: Таблица `dictionary_owner`

### Конфигурация

1. **API URLs**: Настройка backend endpoints
2. **Таймауты**: Конфигурация времени ожидания
3. **Логирование**: Настройка уровней логирования
4. **Кэширование**: Конфигурация Redis (опционально)

### Мониторинг

1. **Логи**: Отслеживание ошибок доступа
2. **Метрики**: Время ответа API
3. **Алерты**: Уведомления о проблемах
4. **Дашборды**: Визуализация статистики доступа
